version: 2

models:
  - name: int_automated_communications_simple
    description: >
      A simplified model for tracking automated and programmatic communications sent to patients.
      This model identifies automated messages using text patterns, standardized formats, and communication
      behaviors - without depending on other intermediate models to avoid circular dependencies.

    meta:
      owner: "Data Engineering"
      system: "System F: Communications"
      contains_phi: false
      refresh_frequency: "daily"
      improved_version: true

    config:
      materialized: incremental
      schema: intermediate
      unique_key: automated_communication_id
      tags: ["communications", "intermediate"]

    columns:
      - name: automated_communication_id
        description: Unique surrogate key for the automated communication record
        tests:
          - unique
          - not_null

      - name: communication_id
        description: >
          Foreign key to the original communication record (commlog_id from stg_opendental__commlog).
          This links the automated communication back to the source communication log entry.
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__commlog')
              field: commlog_id

      - name: template_id
        description: >
          Foreign key to a template record that would be used to generate this communication.
          This is NULL in the simplified model as it doesn't depend on the templates model.

      - name: trigger_type
        description: >
          Categorizes the automated communication by its trigger or purpose.
          Examples include: appointment_reminder, recall_notice, birthday_greeting, balance_reminder, etc.
        tests:
          - not_null

      - name: trigger_details
        description: >
          Additional details about what triggered the communication. This field
          captures IDs or dates extracted from the content, such as appointment IDs,
          statement IDs, or recall dates in a structured format.

      - name: scheduled_datetime
        description: >
          The date and time when the communication was scheduled to be sent.
          Defaults to the creation timestamp if specific scheduling info is not available.
        tests:
          - not_null

      - name: sent_datetime
        description: >
          The actual date and time when the communication was sent.
          Sourced from the communication_datetime in the commlog.
        tests:
          - not_null

      - name: status
        description: >
          Current status of the communication. Values include:
          - responded_positive: Patient confirmed or responded affirmatively
          - responded_negative: Patient cancelled or declined
          - undelivered: Communication was not delivered successfully
          - sent: Communication was sent but no response recorded
        tests:
          - not_null
          - accepted_values:
              values: ['responded_positive', 'responded_negative', 'undelivered', 'sent']

      - name: recipient_count
        description: >
          Number of recipients for this communication. Default is 1 for individual messages.
          Would be higher for batch communications.
        tests:
          - not_null
          - positive_values

      - name: open_count
        description: >
          For email communications (mode = 1), tracks if the email was opened based on content patterns.
          This is a simplified implementation and would be more accurate with actual email tracking data.
        tests:
          - not_null

      - name: click_count
        description: >
          For email communications (mode = 1), tracks if links in the email were clicked based on content patterns.
          This is a simplified implementation and would be more accurate with actual email tracking data.
        tests:
          - not_null

      - name: reply_count
        description: >
          Tracks if the communication received a reply, identified by outcome values that
          indicate patient interaction (confirmed, rescheduled, cancelled).
        tests:
          - not_null

      - name: bounce_count
        description: >
          For email communications (mode = 1), tracks if the email bounced based on content patterns.
          This is a simplified implementation and would be more accurate with actual email delivery data.
        tests:
          - not_null

      - name: model_created_at
        description: Timestamp when this record was first created in the model
        tests:
          - not_null

      - name: model_updated_at
        description: Timestamp when this record was last updated in the model
        tests:
          - not_null