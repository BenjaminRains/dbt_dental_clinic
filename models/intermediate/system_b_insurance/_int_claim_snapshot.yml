version: 2

models:
  - name: int_claim_snapshot
    description: >
      Intermediate model for claim snapshots, tracking claim states at various points in time.
      This model provides historical context for claim changes and supports insurance payment tracking.
      
      Key features:
      - Tracks claim states and changes over time
      - Maintains both estimated and actual payment amounts
      - Preserves write-off and allowed amount history
      - Supports claim history analysis
      
      Data Sources:
      - stg_opendental__claimsnapshot: Base snapshot information
      - stg_opendental__claimproc: Actual claim procedure details
      
      Business rules:
      - Snapshots are preserved for historical analysis
      - Both estimated and actual amounts are tracked
      - Timestamps are used for chronological ordering
      - Snapshot triggers indicate the reason for the snapshot
    
    columns:
      - name: claim_snapshot_id
        description: Primary key for the claim snapshot record
        tests:
          - unique
          - not_null
      
      - name: claim_id
        description: Foreign key to the insurance claim
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__claim')
              field: claim_id
      
      - name: procedure_id
        description: Foreign key to the procedure
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__procedurelog')
              field: procedure_id
      
      - name: patient_id
        description: Foreign key to the patient
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id
      
      - name: plan_id
        description: Foreign key to the insurance plan
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__insplan')
              field: insurance_plan_id
      
      - name: claim_type
        description: Type of claim (e.g., primary, secondary)
        tests:
          - not_null
      
      - name: write_off_amount
        description: Estimated write-off amount at snapshot time
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
      
      - name: insurance_payment_estimate
        description: Estimated insurance payment amount at snapshot time
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
      
      - name: fee_amount
        description: Fee amount at snapshot time
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
      
      - name: entry_timestamp
        description: Timestamp when the snapshot was created
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'::timestamp"
              max_value: "'{{ var('max_valid_date', 'current_date') }}'::timestamp"
      
      - name: actual_payment_amount
        description: Actual insurance payment amount from claim procedure
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -10000
              max_value: 10000
      
      - name: actual_write_off
        description: Actual write-off amount from claim procedure
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
      
      - name: actual_allowed_amount
        description: Actual allowed amount from claim procedure
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
      
      - name: snapshot_trigger
        description: Indicator of what triggered this snapshot (e.g., claim submission, payment received)
        tests:
          - not_null
      
      - name: created_at
        description: Timestamp when the snapshot was created
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'::timestamp"
              max_value: "'{{ var('max_valid_date', 'current_date') }}'::timestamp"
      
      - name: updated_at
        description: Timestamp when the snapshot was last updated
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'::timestamp"
              max_value: "'{{ var('max_valid_date', 'current_date') }}'::timestamp" 