version: 2

models: 
  - name: int_adjustments
    description: >
      Comprehensive model that combines adjustment data with procedure information and definitions
      to track and analyze fee adjustments. Part of System A: Fee Processing & Verification workflow.
      
      Data Sources:
      - stg_opendental__adjustment: Base adjustment records and amounts
      - stg_opendental__definition: Adjustment type definitions and categories
      - int_procedure_complete: Procedure details and standard fees
      
      Key features:
      - Links adjustments to procedures and their standard fees
      - Includes definition mappings for adjustment types
      - Calculates adjusted fees and adjustment impacts
      - Tracks various adjustment types and categories
      - Supports fee adjustment analysis and reporting

      Note: As an out-of-network focused clinic:
      - Most adjustments are not insurance-related
      - Fee schedules serve as reference data only
      - Standard fees may differ significantly from actual fees
      - Adjustments often reflect patient-specific arrangements

      Note: Relevant definition categories include:
      - Category 0: Core adjustment types (Adjustment, Discount, Insurance Payment)
      - Category 1: Specific adjustment reasons
      - Category 15: Discount types
      - Category 29: Payment plan types

      Note: Data Quality Findings:
      - Some zero-fee procedures have non-zero adjustments (both large and very small)
      - Some low-fee procedures have disproportionately large adjustments
      - Some adjustments are missing procedure information
      - See stakeholders/adjustment_data_quality_notice.md for detailed findings
    
    columns:
      - name: adjustment_id
        description: Primary key from adjustment table
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('stg_opendental__adjustment')
              field: adjustment_id

      - name: patient_id
        description: Foreign key to patient
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id

      - name: procedure_id
        description: Foreign key to procedure
        tests:
          - relationships:
              to: ref('int_procedure_complete')
              field: procedure_id

      - name: provider_id
        description: Provider who authorized the adjustment
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id

      - name: clinic_id
        description: Clinic where adjustment was made
        tests: [] # MDC clinic only. No need to test.

      - name: adjustment_amount
        description: Amount of the adjustment (can be positive or negative)
        tests:
          - dbt_expectations.expression_is_true:
              expression: >
                CASE 
                  WHEN procedure_fee = 0 THEN adjustment_amount = 0
                  WHEN procedure_fee > 0 AND procedure_fee <= 1000 THEN adjustment_amount BETWEEN -10000 AND 10000
                  WHEN procedure_fee > 1000 THEN adjustment_amount BETWEEN -20000 AND 20000
                  ELSE FALSE
                END
              severity: error

      - name: adjustment_date
        description: Date when adjustment was applied
        tests:
          - not_null

      - name: procedure_date
        description: Date of the associated procedure
        tests:
          - not_null

      - name: adjustment_category
        description: Category of the adjustment
        tests:
          - not_null

      - name: adjustment_size
        description: Size classification of the adjustment
        tests:
          - not_null

      - name: adjustment_type_name
        description: Human-readable name of the adjustment type from definitions table
        tests:
          - relationships:
              to: ref('stg_opendental__definition')
              field: item_name
              config:
                severity: warn

      - name: adjustment_type_value
        description: Value associated with the adjustment type from definitions table
        tests:
          - relationships:
              to: ref('stg_opendental__definition')
              field: item_value
              config:
                severity: warn

      - name: adjustment_category_type
        description: Category ID from definitions table indicating the type of adjustment
        tests:
          - relationships:
              to: ref('stg_opendental__definition')
              field: category_id
              config:
                severity: warn

      - name: procedure_code
        description: ADA procedure code from linked procedure
        tests: []

      - name: procedure_description
        description: Description of the linked procedure

      - name: procedure_fee
        description: Original fee amount before adjustment
        tests:
          - dbt_expectations.expression_is_true:
              expression: >
                CASE 
                  WHEN procedure_code IN ('D6114', 'D6115') THEN procedure_fee >= 0 AND procedure_fee <= 30000
                  ELSE procedure_fee >= 0 AND procedure_fee <= 10000
                END
              severity: error

      - name: fee_schedule_id
        description: ID of the fee schedule used

      - name: standard_fee
        description: Standard fee amount from fee schedule
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              severity: warn

      - name: adjusted_fee
        description: Final fee amount after adjustment (procedure_fee + adjustment_amount)
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              severity: warn

      - name: adjustment_impact
        description: Classification of adjustment impact based on percentage of procedure fee
        tests:
          - accepted_values:
              values: ['major', 'moderate', 'minor']

      - name: is_procedure_adjustment
        description: Flag indicating if adjustment is tied to a specific procedure
        tests:
          - not_null

      - name: is_retroactive_adjustment
        description: Flag indicating if adjustment was applied after the procedure date
        tests:
          - not_null

      - name: is_provider_discretion
        description: Flag indicating if adjustment was at provider's discretion
        tests:
          - not_null

      - name: is_employee_discount
        description: Flag indicating if adjustment is an employee discount
        tests:
          - not_null

      - name: is_military_discount
        description: Flag indicating if adjustment is a military discount
        tests:
          - not_null

      - name: is_courtesy_adjustment
        description: Flag indicating if adjustment is a courtesy adjustment
        tests:
          - not_null

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000
          max_value: 50000

      - dbt_expectations.expression_is_true:
          expression: "adjusted_fee >= 0"
          severity: error

      - dbt_expectations.expression_is_true:
          expression: "adjustment_date >= procedure_date"
          severity: warn

      - dbt_expectations.expression_is_true:
          expression: "abs(adjustment_amount) <= procedure_fee * 2"
          severity: warn

      - dbt_expectations.expression_is_true:
          expression: "not (adjustment_type_name is null and adjustment_type_id is not null)"
          severity: warn

      - dbt_expectations.expression_is_true:
          expression: "not (adjustment_category is null and adjustment_type_id is not null)"
          severity: warn
