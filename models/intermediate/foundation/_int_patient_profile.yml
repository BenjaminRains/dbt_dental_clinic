version: 2

models:
  - name: int_patient_profile
    description: >
      Foundation model combining core patient information from staging models to 
      create comprehensive patient profiles.

      Data Sources:
      - stg_opendental__patient: Base patient information, demographics, and financial data
      - stg_opendental__patientlink: Family relationships and linkages
      - stg_opendental__patientnote: Medical notes, treatment information, and emergency contacts
      - stg_opendental__provider: Provider assignments and relationships

      Key Features:
      - Basic demographics and contact information
      - Family relationships
      - Emergency contacts
      - Medical notes and treatment information
      - Patient preferences (pronouns, consent)
      - One-to-one relationship with patients (32,700 records as of 2025)
      - Base model for int_ar_analysis (record count must match)

      Usage:
      Primary source for patient profile information in downstream analytics.
      Base model for AR analysis and financial reporting.

    
    config:
      materialized: table
      unique_key: patient_id
      tags: ['foundation', 'weekly']
    
    columns:
      - name: patient_id
        description: Unique identifier for each patient
        tests:
          - unique
          - not_null

      - name: guarantor_id
        description: ID of the guarantor responsible for patient's account
        tests:
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id

      - name: primary_provider_id
        description: ID of the patient's primary provider
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id

      - name: secondary_provider_id
        description: ID of the patient's secondary provider
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id

      - name: preferred_name
        description: Patient's preferred name
        tests:
          - not_null

      - name: middle_initial
        description: Patient's middle initial

      - name: gender
        description: Patient's gender (0=Male, 1=Female, 2=Other)
        tests:
          - accepted_values:
              values: [0, 1, 2]

      - name: language
        description: Patient's preferred language
        tests:
          - not_null
          - config:
              severity: warn

      - name: birth_date
        description: Patient's date of birth
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'1900-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: age
        description: Patient's calculated age
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 120

      - name: patient_status
        description: >
          Current status of the patient
          - 2 = Active
          - Other statuses indicate various inactive states
        tests:
          - not_null
          - accepted_values:
              values: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]

      - name: position_code
        description: Patient position classification
        tests:
          - not_null

      - name: student_status
        description: Patient's student status (N=Not a student, ''=Unknown/Not specified)
        tests:
          - accepted_values:
              values: ['N', '']
              config:
                severity: warn

      - name: preferred_confirmation_method
        description: >
          Patient's preferred method for appointment confirmations.
          
          Current distribution (as of 2024):
          - 0 (15.17%): Assumed to be "None/No Preference"
          - 2 (58.52%): Assumed to be "Email"
          - 4 (26.26%): Assumed to be "Text"
          - 8 (0.04%): Assumed to be "Phone"
          
          Note: These mappings are assumptions based on data distribution patterns and OpenDental's typical bit flag usage.
          They should be verified with stakeholders before being used for business decisions.
        tests:
          - accepted_values:
              values: [0, 2, 4, 8]

      - name: preferred_contact_method
        description: >
          Patient's preferred method for general contact.
          
          Current distribution (as of 2024):
          - 0 (13.35%): Assumed to be "None/No Preference"
          - 2 (58.53%): Assumed to be "Email"
          - 3 (0.01%): Assumed to be "Mail"
          - 4 (28.08%): Assumed to be "Phone"
          - 5 (0.01%): Assumed to be "Text"
          - 6 (0.00%): Assumed to be "Other"
          - 8 (0.02%): Assumed to be "Portal"
          
          Note: These mappings are assumptions based on data distribution patterns and OpenDental's typical bit flag usage.
          They should be verified with stakeholders before being used for business decisions.
        tests:
          - accepted_values:
              values: [0, 2, 3, 4, 5, 6, 8]

      - name: text_messaging_consent
        description: >
          Whether patient has consented to text messaging
          - 0: Consent given (87.43%)
          - 1: No consent (8.33%)
          - 2: Unknown/Not specified (4.24%)
        tests:
          - accepted_values:
              values: [0, 1, 2]
              config:
                severity: warn

      - name: estimated_balance
        description: Estimated current balance
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -1000000
              max_value: 1000000

      - name: total_balance
        description: Total balance on account
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: -1000000
              max_value: 1000000

      - name: has_insurance_flag
        description: >
          Indicates if patient has insurance.
          
          Values in source data (as of 2025):
          - 'I': Patient has insurance (59.28% of records)
          - '': No insurance or unknown (40.72% of records)
          
          Note: The 'I' notation is OpenDental's single-character flag for "Insurance".
          This is a common pattern in the system where single letters are used as flags.
          The exact meaning should be verified with stakeholders.
        tests:
          - accepted_values:
              values: ['I', '']

      - name: family_id
        description: ID linking to related family members
        tests:
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id

      - name: family_link_type
        description: Type of family relationship
        tests:
          - accepted_values:
              values: [1]

      - name: family_linked_at
        description: Timestamp when family relationship was established
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: emergency_contact_name
        description: Name of emergency contact (ICE)
        tests:
          - not_null:
              where: "patient_status = 2"  # Required for active patients
              config:
                severity: error

      - name: emergency_contact_phone
        description: Phone number of emergency contact
        tests:
          - not_null:
              where: "patient_status = 2"  # Required for active patients
              config:
                severity: error

      - name: medical_notes
        description: General medical notes

      - name: treatment_notes
        description: Notes related to treatment

      - name: pronoun
        description: Patient's preferred pronouns (0=default)
        tests:
          - accepted_values:
              values: [0]
              config:
                severity: warn

      - name: consent
        description: Patient's recorded consents
        tests:
          - not_null:
              where: "patient_status = 2"  # Required for active patients
              config:
                severity: error

      - name: first_visit_date
        description: Date of patient's first visit
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: patient_created_at
        description: Timestamp when patient record was created
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: patient_updated_at
        description: >
          Timestamp when patient record was last updated.
          Warning: If this is older than 2 years for active patients (status=2),
          the patient may be effectively inactive despite their active status.
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: notes_created_at
        description: Timestamp when patient notes were created
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: notes_updated_at
        description: Timestamp when patient notes were last updated
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: model_created_at
        description: Timestamp when this model record was created
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

      - name: model_updated_at
        description: Timestamp when this model record was last updated
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2023-01-01'"
              max_value: "{{ var('max_valid_date', 'current_date') }}"

    tests:
      - dbt_utils.equal_rowcount:
          compare_model: ref('stg_opendental__patient')
          config:
            severity: error
            description: "Patient count must match source data"

      - dbt_utils.expression_is_true:
          expression: "NOT(patient_updated_at < CURRENT_DATE - INTERVAL '2 years' AND patient_status = 2)"
          config:
            severity: warn
            where: "patient_status = 2"
            description: "Active patients should have recent updates"

      - dbt_utils.expression_is_true:
          expression: "NOT(has_insurance_flag = true AND emergency_contact_name IS NULL)"
          config:
            severity: error
            where: "patient_status = 2"
            description: "Active patients with insurance must have emergency contact"

      - dbt_utils.expression_is_true:
          expression: "NOT(patient_status = 2 AND first_visit_date IS NULL)"
          config:
            severity: error
            description: "Active patients must have a first visit date"

    meta:
      owner: 'data_team'
      contains_phi: true
      refresh_frequency: 'daily'
      upstream_sources:
        - 'stg_opendental__patient'
        - 'stg_opendental__patientlink'
        - 'stg_opendental__patientnote'
      data_quality_requirements:
        - "All active patients must have emergency contact information"
        - "All active patients must have a first visit date"
        - "Patient status must be valid (0-9)"
        - "Age must be between 0 and 120"
        - "Balances must be within reasonable ranges"
        - "Dates must be within valid ranges"
        - "Gender must be one of M, F, O, U"
        - "Contact preferences must be valid"
        - "Family relationships must be valid"
        - "Patient updates must be recent for active patients"
