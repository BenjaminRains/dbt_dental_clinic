version: 2

models:
  - name: stg_opendental__commlog
    description: Staging model for communication logs from OpenDental
    columns:
      - name: commlog_id
        description: Primary key of the communication log
        tests:
          - unique
          - not_null

      - name: patient_id
        description: Foreign key to stg_opendental__patient
        tests:
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id

      - name: user_id
        description: >
          Foreign key to stg_opendental__userod, represents the user who created/handled the communication. 
          Links to user_id (formerly UserNum) in userod table.

          Special cases:
          - user_id = 0: System-generated communications (no specific user)
            Represents approximately 54,578 records from 2023-01-01 to 2025-02-17
            These are automated communications from the system for:
            * Appointment notifications (type 224)
            * General patient communications (type 228)
            * Clinical communications (type 603)
            * Legacy system communications (type 0)
          - Excluded inactive users: 20, 36, 43, 45, 51, 54, 9280, 9281
            * Jennifer Berg (20) - Active provider, no commlog entries
            * Becky Solomey (36) - Hidden provider
            * LocalMed (43) - Hidden provider
            * Maria Barajas (45) - Hidden provider
            * Edward Karateew (51) - Hidden provider
            * System/unknown users (54, 9280, 9281)
        tests:
          - relationships:
              to: ref('stg_opendental__userod')
              field: user_id
              where: "user_id != 0 AND user_id NOT IN (20, 36, 43, 45, 51, 54, 9280, 9281)"  # Exclude system and inactive users
              config:
                description: >
                  This test excludes system-generated communications (user_id = 0) and known inactive users.
                  System communications represent automated messages for appointments, notifications, and clinical updates.

      - name: program_id
        description: >
          Foreign key to stg_opendental__program, represents the program/system used for communication.
          Special cases:
          - program_id = 0: System default/no specific program (51.74% of records)
            Used for basic system communications where no specific external program is involved
          - program_id = 95: Legacy communication system (48.26% of records)
            Primarily used for communications with:
            * Mode 5 communications (26,392 records)
            * Mode 1 communications (18,405 records)
            * Mode 3 communications (15,761 records)
            * Mode 0 communications (357 records)
        tests:
          - relationships:
              to: ref('stg_opendental__program')
              field: program_id
              where: "program_id NOT IN (0, 95)"  # Only check non-system program IDs
              severity: error  # Error if any other program_id doesn't exist in program table
              config:
                description: >
                  This test verifies that any program_id other than 0 (system default) or 95 (legacy system)
                  must exist in the program table. These two special IDs are excluded from the check as they
                  represent internal system communications and are not present in the program table by design.

      # Other important fields
      - name: communication_datetime
        description: Date and time when the communication occurred

      - name: communication_type
        description: >
          The type of communication in the system. Main types:
          - 0: Legacy system communications (mode 5) - General automated communications
          - 224: Primary appointment notification system (mode 1,4) - Appointment-related communications
          - 228: Secondary automated communication system (mode 4) - General patient communications
          - 603: Tertiary communication system (mode 5) - Clinical communications
          - 226: Billing and financial communications
          - 225: Insurance and claims communications
          - 571: Insurance narratives and documentation
          - 432: Medical clearances and prescriptions
          - 509/510: Surgical procedures and clearances
          - 614/615: Referrals and specialist communications
          - 636: Treatment plans and financial arrangements
        tests:
          - not_null
          - accepted_values:
              values: [0, 224, 228, 603, 226, 225, 571, 636, 432, 615, 509, 614, 510, 427, 428, 429, 425]

      - name: mode
        description: >
          The mode or channel used for communication, ordered by frequency of use:
          
          Primary Communication Modes (99.99% of records):
          - 4: In-person communications (37.31%)
            Used for all communication types except legacy system communications
          - 5: SMS/text message communications (22.07%)
            Used for appointment notifications, clinical, and treatment plan communications
          - 1: Email communications (20.09%)
            Used for appointment notifications, clinical, and treatment plan communications
          - 3: Letter communications (16.78%)
            Used for all communication types including insurance and medical clearances
          - 0: Unknown/Unspecified mode (3.54%)
            Used across all communication types, likely historical or system-generated
          - 2: Phone call communications (0.20%)
            Used primarily for insurance, clinical, and treatment plan communications
          
          Rare/Historical Modes (0.01% of records):
          - 6: Clinical communication mode (1 record)
            Used once for clinical communications (type 603)
          - 8: Additional communication mode (1 record)
            Used once for general patient communications (type 228)
        tests:
          - not_null
          - accepted_values:
              values: [0, 1, 2, 3, 4, 5, 6, 8]

      - name: is_sent
        description: >
          Flag indicating the direction of communication:
          - 1: Communication was sent from the practice to the patient
          - 0: Communication was received from the patient to the practice
        tests:
          - not_null
          - accepted_values:
              values: [0, 1]

      - name: communication_source
        description: >
          Source of the communication:
          - 1: Sent
          - 2: Received
          - 3: Failed
          - NULL: Unknown/Not specified
        tests:
          - accepted_values:
              values: [1, 2, 3, null]

      # Metadata columns
      - name: _loaded_at
        description: Timestamp of when this record was loaded into the warehouse
        tests:
          - not_null

      - name: _created_at
        description: Timestamp of when this record was created in the source system (OpenDental)
        tests:
          - not_null

      - name: _updated_at
        description: Timestamp of when this record was last updated in the source system (OpenDental)
        tests:
          - not_null
