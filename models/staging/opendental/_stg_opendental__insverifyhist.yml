version: 2

models:
  - name: stg_opendental__insverifyhist
    description: >
      Staging model for insurance verification history records. This model tracks the history
      of insurance verification activities.
      
      Data Quality Note: There are 1,987 history records without corresponding verification records.
       See docs/data_quality/insurance_verification_orphaned_records.md for analysis.
      
      Data Quality Note: The equality test comparing verification and history records is failing
       with 29,708 mismatches. This is expected behavior as verification records store target dates
        while history records track actual verification dates. 
        See docs/data_quality/insurance_verification_orphaned_verification_records.md for analysis.

    columns:
      - name: insurance_verifyhist_id
        description: Primary key for the insurance verification history record
        tests:
          - unique
          - not_null

      - name: insurance_verify_id
        description: >
          Foreign key to the insurance verification record.
          
          Data Quality Note: The relationships test is failing with 1,987 history records that do
           not have corresponding verification records. These records show patterns of sequential
            verification activities and are primarily created by users 57 and 9282. 
            See docs/data_quality/insurance_verification_orphaned_records.md for detailed analysis.
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__insverify')
              field: insurance_verify_id
              config:
                description: >
                  This test verifies that every history record has a corresponding verification record.
                  Note: There are 1,987 history records without corresponding verification records.
                  See docs/data_quality/insurance_verification_orphaned_records.md for analysis.

      - name: verify_type
        description: Type of verification (1=Insurance Subscriber, 2=Insurance Plan)
        tests:
          - not_null
          - accepted_values:
              values: [1, 2]

      - name: foreign_key_id
        description: >
          Foreign key to the related record (subscriber or plan).
          
          Data Quality Note: The relationships test is failing with 1,946 history records that do
           not have corresponding verification records. These records show patterns of sequential
            verification activities and are primarily created by users 57 and 9282. 
            See docs/data_quality/insurance_verification_orphaned_records.md for detailed analysis.
        tests:
          - not_null
          - relationships_where:
              to: ref('stg_opendental__inssub')
              field: inssub_id
              config:
                where: "verify_type = 1"
                description: >
                  This test verifies that every Type 1 history record has a corresponding subscriber record.
                  Note: There are 283 Type 1 history records without corresponding subscribers.
                  See docs/data_quality/insurance_verification_orphaned_verification_records.md for analysis.

      - name: last_verified_date
        description: Date when the verification was last performed
        tests:
          - not_null

      - name: last_assigned_date
        description: >
          Date when the verification was last assigned.
          
          Data Quality Note: The relationships test is failing with 17 history records where the
           last_assigned_date does not match the corresponding verification record. This is under
            investigation to determine if this is expected behavior or a data quality issue.
        tests:
          - not_null

      - name: entry_timestamp
        description: Timestamp when the history record was created
        tests:
          - not_null

      - name: user_id
        description: ID of the user who performed the verification
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__user')
              field: user_id

      - name: note
        description: Additional notes about the verification

      - name: next_history_id
        description: ID of the next history record in the verification chain
        tests:
          - relationships:
              to: ref('stg_opendental__insverifyhist')
              field: insurance_verifyhist_id

      - name: prev_history_id
        description: ID of the previous history record in the verification chain
        tests:
          - relationships:
              to: ref('stg_opendental__insverifyhist')
              field: insurance_verifyhist_id

      - name: _loaded_at
        description: Timestamp when the record was loaded into the data warehouse
        tests:
          - not_null

      - name: _created_at
        description: Timestamp when the record was created in the source system
        tests:
          - not_null

      - name: _updated_at
        description: Timestamp when the record was last updated in the source system
        tests:
          - not_null

    tests:
      # Test that verify_type=1 records have valid inssub references
      - dbt_utils.relationships_where:
          column_name: foreign_key_id
          to: ref('stg_opendental__inssub')
          field: inssub_id
          from_condition: "verify_type = 1"
          to_condition: "inssub_id is not null"

      # Test that history records match their source verify records
      # Note: While we have multiple history records per verification,
      # we only care that the fields match between corresponding records.
      # The business logic of which record is current is handled elsewhere.
      - relationships:
          column_name: foreign_key_id
          to: ref('stg_opendental__insverify')
          field: foreign_key_id

      - relationships:
          column_name: verify_type
          to: ref('stg_opendental__insverify')
          field: verify_type

      - relationships:
          column_name: last_assigned_date
          to: ref('stg_opendental__insverify')
          field: last_assigned_date

    config:
      tags: ['staging', 'insurance', 'daily']
