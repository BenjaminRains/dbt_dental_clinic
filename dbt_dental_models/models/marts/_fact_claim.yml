version: 2

models:
  - name: fact_claim
    description: >
      Fact table containing individual claim transactions and procedures.
      This model serves as the foundation for claim-level analysis and reporting,
      providing detailed information about each claim procedure and its associated
      payments, statuses, and documentation.

      This fact table serves as the central hub for insurance billing and revenue cycle management
      and provides comprehensive financial transaction tracking. Part of System A: Financial Management workflow.
      
      Key Features:
      - Individual claim transaction tracking: Enables procedure-level financial analysis and reconciliation
      - Payment processing integration: Provides comprehensive payment tracking with EOB documentation
      - Revenue cycle management: Supports billing analysis, collection tracking, and financial performance monitoring
      - Financial calculation engine: Calculates payment timing, completion status, and documentation compliance
      - Data integration hub: Consolidates claim, payment, and documentation data from multiple sources
      
      Data Sources:
      - int_claim_details: Core claim transaction data with procedure-level granularity
      - int_claim_payments: Payment processing information and EOB documentation metadata
      - int_claim_snapshot: Historical claim status snapshots for audit and compliance tracking
      - int_claim_tracking: Claim processing workflow tracking and status transitions
      
      Business Logic Features:
      - Composite key deduplication: Ensures unique records using claim_id + procedure_id + claim_procedure_id
      - Payment status categorization: Automatically categorizes claims as Paid, Denied, Pending, or Rejected
      - Billing status determination: Classifies procedures as Billable or Non-Billable based on business rules
      - Payment timing calculation: Computes days between claim submission and payment receipt
      - Completion status tracking: Determines payment completion status (Write-off, Patient Balance, Fully Paid, Partial)
      - EOB documentation validation: Tracks documentation completeness for audit compliance
      
      Financial Calculations:
      - Payment timing analysis: Calculates payment_days_from_claim for revenue cycle optimization
      - Payment completion assessment: Determines payment_completion_status for collection analysis
      - Documentation compliance: Tracks eob_documentation_status for audit requirements
      - Amount reconciliation: Validates billed vs paid amounts for financial accuracy
      
      Data Quality Notes:
      - Claims are deduplicated using composite key to handle multiple payment scenarios
      - Some claims may have missing payment information (handled with left joins for data completeness)
      - EOB attachments are optional and may be null for some claims (documented in eob_documentation_status)
      - Claim status fields may have different granularity across source systems (normalized in calculated fields)
      - Payment amounts are validated against business rules and financial constraints
      
      Business Rules:
      - All claims must have valid procedure and patient associations for billing integrity
      - Payment amounts must be non-negative and cannot exceed billed amounts
      - EOB documentation is required for payments above certain thresholds
      - Claim status transitions must follow defined business workflow rules

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns: [claim_id, procedure_id, claim_procedure_id]
      - dbt_utils.expression_is_true:
          expression: |
            CASE 
              WHEN check_date IS NULL THEN payment_days_from_claim IS NULL
              WHEN check_date IS NOT NULL THEN payment_days_from_claim = (check_date - claim_date)
              ELSE true
            END
          config:
            severity: error
            description: "Payment days calculation should match check_date - claim_date"
      - dbt_expectations.expect_column_pair_values_A_to_be_greater_than_B:
          column_A: billed_amount
          column_B: allowed_amount
          or_equal: true
          row_condition: "claim_id != 0 AND allowed_amount != -1.0 AND billed_amount > 0"
          config:
            severity: warn
            description: "Allowed amount should not exceed billed amount (excluding pre-auth, placeholder, and zero-billed)"
      - dbt_expectations.expect_column_pair_values_A_to_be_greater_than_B:
          column_A: allowed_amount
          column_B: paid_amount
          or_equal: true
          row_condition: "claim_id != 0 AND allowed_amount != -1.0"
          config:
            severity: warn
            description: "Paid amount should not exceed allowed amount (excluding pre-auth and placeholder values)"

    columns:
      - name: claim_id
        description: >
          Primary key for the claim (maps from "ClaimNum" in OpenDental)
          
          Source Transformation:
          - OpenDental source: "ClaimNum" (CamelCase)
          - Transformed to: claim_id (snake_case with _id suffix)
          
          Business Context:
          - Uniquely identifies each claim record
          - Used as part of composite key for claim procedure identification
          - Critical for claim-level analysis and financial reconciliation
          
          Data Quality Considerations:
          - Special case: claim_id = 0 represents pre-authorization requests or draft claims not yet submitted
          - These records may have future-dated claim_date values representing planned/scheduled procedures
          - Pre-authorizations are sent to insurance BEFORE procedures are performed to get approval
          - Draft claims are claims being prepared but haven't been submitted yet
          - These are legitimate business records and should be included in analytics
        tests:
          - not_null

      - name: procedure_id
        description: >
          Foreign key to the procedure (maps from "ProcNum" in OpenDental)
          
          Source Transformation:
          - OpenDental source: "ProcNum" (CamelCase)
          - Transformed to: procedure_id (snake_case with _id suffix)
          
          Business Relationship:
          - Links to dim_procedure for procedure details and categorization
          - Enables procedure-level analysis and reporting
          - Critical for billing accuracy and procedure tracking
        tests:
          - not_null

      - name: claim_procedure_id
        description: >
          Unique identifier for the claim procedure combination
          
          Business Context:
          - Part of composite key ensuring unique claim procedure records
          - Enables tracking of multiple procedures within a single claim
          - Critical for procedure-level payment and status tracking
        tests:
          - not_null

      - name: insurance_plan_id
        description: >
          Foreign key to the insurance plan (maps from "PlanNum" in OpenDental)
          
          Source Transformation:
          - OpenDental source: "PlanNum" (CamelCase)
          - Transformed to: insurance_plan_id (snake_case with _id suffix)
          
          Business Relationship:
          - Links to dim_insurance for plan details and coverage information
          - Enables insurance-specific analysis and reporting
          - Critical for billing accuracy and coverage validation
        tests:
          - not_null:
              config:
                severity: warn
          - relationships:
              to: ref('dim_insurance')
              field: insurance_plan_id
              config:
                severity: error
                description: "All claims must reference valid insurance plans for billing integrity"

      - name: patient_id
        description: >
          Foreign key to the patient (maps from "PatNum" in OpenDental)
          
          Source Transformation:
          - OpenDental source: "PatNum" (CamelCase)
          - Transformed to: patient_id (snake_case with _id suffix)
          
          Business Relationship:
          - Links to dim_patient for patient demographics and history
          - Enables patient-level analysis and reporting
          - Critical for patient billing and care coordination
        tests:
          - not_null
          - relationships:
              to: ref('dim_patient')
              field: patient_id
              config:
                severity: error
                description: "All claims must reference valid patients for billing integrity"

      - name: provider_id
        description: >
          Foreign key to the provider (maps from "ProvNum" in OpenDental)
          
          Source Transformation:
          - OpenDental source: "ProvNum" (CamelCase)
          - Transformed to: provider_id (snake_case with _id suffix)
          
          Business Relationship:
          - Links to dim_provider for provider details and performance tracking
          - Enables provider-level analysis and reporting
          - Critical for provider billing and performance monitoring
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedures haven't been completed yet
          - These procedures don't exist in procedurelog, so provider_id cannot be determined
          - For pre-auth claims with scheduled appointments, provider_id can optionally be populated from appointment data (see PROVIDER_ID_NULL_ANALYSIS.md for implementation guide)
          - Appointment provider may differ from actual performing provider - use with caution in provider performance analysis
        tests:
          - relationships:
              to: ref('dim_provider')
              field: provider_id
              config:
                severity: error
                where: "provider_id IS NOT NULL"
                description: "All claims with provider_id must reference valid providers (excluding pre-auth claims where NULL is expected)"

      - name: claim_date
        description: >
          Date when the claim was submitted
          
          Business Context:
          - Used for time-based analysis and reporting
          - Critical for revenue cycle management and payment timing analysis
          - Enables monthly, quarterly, and annual financial reporting
        tests:
          - not_null
          - relationships:
              to: ref('dim_date')
              field: date_id
              config:
                severity: error
                description: "All claims must have valid submission dates for financial reporting"
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2020-01-01'"
              max_value: "CURRENT_DATE + INTERVAL '1 year'"
              row_condition: "claim_id != 0"
              config:
                severity: warn
                description: "Claim dates should be within reasonable range (excluding pre-auth claims which may have future dates)"

      - name: claim_status
        description: >
          Current status of the claim in the billing workflow
          
          Valid Values:
          - 'S': Sent - Claim has been sent to insurance and is being tracked for response
          - 'W': Waiting - Special status for high-value claims in transition
          - 'R': Received - Claim has been fully processed by insurance with payment or denial
          - 'H': Hold - Secondary claim waiting for primary insurance processing completion
          - 'U': Unsent - Claim has not been sent to insurance yet
          
          Data Quality Considerations:
          - NULL values are expected for pre-authorization/draft claims (`claim_id = 0`)
          - These claims haven't been submitted yet, so they don't have a claim status
          - Pre-auth claims are legitimate business records representing planned procedures
          
          Business Rules:
          - Status transitions must follow defined workflow rules
          - Status affects payment processing and collection activities
        tests:
          - not_null:
              config:
                severity: warn
                where: "claim_id != 0"
                description: "Claim status should be present for submitted claims (excluding pre-auth/draft claims)"
          - accepted_values:
              values: ['S', 'W', 'R', 'H', 'U']
              config:
                severity: error
                where: "claim_status IS NOT NULL"
                description: "Claim status must be one of the defined workflow states"

      - name: claim_type
        description: >
          Type of claim indicating billing priority and processing order
          
          Valid Values:
          - 'P': Primary insurance claim
          - 'S': Secondary insurance claim
          - 'Other': Other claim types
          
          Data Quality Considerations:
          - NULL values are expected for pre-authorization/draft claims (`claim_id = 0`)
          - These claims haven't been submitted yet, so they don't have a claim type
          - Pre-auth claims are legitimate business records representing planned procedures
          
          Business Rules:
          - Determines billing sequence and payment coordination
          - Affects payment processing and patient responsibility calculations
        tests:
          - not_null:
              config:
                severity: warn
                where: "claim_id != 0"
                description: "Claim type should be present for submitted claims (excluding pre-auth/draft claims)"
          - accepted_values:
              values: ['P', 'S', 'Other']
              config:
                severity: error
                where: "claim_type IS NOT NULL"
                description: "Claim type must be one of the defined billing priorities"

      - name: claim_procedure_status
        description: >
          Status of the specific procedure within the claim
          
          Valid Values:
          - 0: Estimate/Pre-determination - Pre-authorization request for procedure
          - 1: Claim - Standard insurance claim for procedure
          - 2: Excluded - Procedure excluded from claim processing
          - 3: CapClaim - Capitation claim (per-member payment model)
          - 4: CapComplete - Capitation claim completed
          - 6: InsHist - Insurance history record
          - 9: Pending Review/Reconsideration - Claim under review or appeal
          
          Business Context:
          - Individual procedures can have different statuses within the same claim
          - Affects procedure-level payment and collection activities
          - Status codes 5 and 7 exist in OpenDental but don't appear in current data
        tests:
          - not_null
          - accepted_values:
              values: [0, 1, 2, 3, 4, 6, 9]
              config:
                severity: error
                description: "Procedure status must be one of the defined numeric status codes (0=Estimate, 1=Claim, 2=Excluded, 3=CapClaim, 4=CapComplete, 6=InsHist, 9=Pending Review)"

      - name: billed_amount
        description: >
          Amount billed for the procedure to insurance
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Calculation: Based on fee schedule and procedure codes
          - Business Rules: Must be non-negative and within reasonable ranges
          
          Accounting Impact:
          - Used for revenue recognition and billing reconciliation
          - Critical for financial reporting and audit compliance
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Billed amounts should be reasonable for dental procedures"

      - name: allowed_amount
        description: >
          Amount allowed by insurance for the procedure
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Calculation: Determined by insurance plan coverage and fee schedules
          - Business Rules: Cannot exceed billed amount, must be non-negative
          
          Accounting Impact:
          - Used for payment reconciliation and patient responsibility calculations
          - Critical for insurance payment processing and audit compliance
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Allowed amounts should be reasonable for dental procedures"

      - name: paid_amount
        description: >
          Amount actually paid by insurance for the procedure
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Calculation: Actual payment received from insurance
          - Business Rules: Cannot exceed allowed amount, must be non-negative
          
          Accounting Impact:
          - Used for revenue recognition and payment reconciliation
          - Critical for financial reporting and collection analysis
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Paid amounts should be reasonable for dental procedures"

      - name: write_off_amount
        description: >
          Amount written off due to insurance adjustments or contractual obligations (legacy field)
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Source: Maps from `claimproc.WriteOff` column in OpenDental
          - **Important Note**: This column is typically $0.00 because write-offs are tracked in the adjustments table, not in claimproc
          
          Data Source:
          - OpenDental source: `claimproc.WriteOff` column
          - However, OpenDental does not actively use this column for write-off tracking
          - Actual write-offs are tracked in `int_adjustments` table with `adjustment_category = 'insurance_writeoff'`
          
          Business Rules:
          - Must be non-negative, typically represents contractual adjustments
          - In practice, this field is usually $0.00 because write-offs are entered as adjustments
          - **Use `adjustment_write_off_amount` instead** for accurate write-off analysis
          
          Accounting Impact:
          - This field may not reflect actual write-offs in the system
          - Kept for backward compatibility and data lineage
          - For accurate write-off analysis, use `adjustment_write_off_amount` field
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Write-off amounts should be reasonable for dental procedures"

      - name: adjustment_write_off_amount
        description: >
          Amount written off from insurance adjustments, aggregated from the adjustments table
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Source: Aggregated from `int_adjustments` table where `adjustment_category = 'insurance_writeoff'`
          - Calculation: `SUM(ABS(adjustment_amount))` grouped by `procedure_id`
          - This is the authoritative source for write-off amounts from adjustments
          
          Data Source:
          - Source: `int_adjustments` table
          - Filter: `adjustment_category = 'insurance_writeoff'` and `procedure_id IS NOT NULL`
          - Aggregation: Sum of absolute values of adjustment amounts per procedure
          
          Business Rules:
          - Must be non-negative (uses ABS of adjustment_amount)
          - Represents write-offs applied to procedures via adjustments
          - A procedure can have multiple write-off adjustments (all are summed)
          - Write-offs reduce revenue and represent contractual adjustments or bad debt
          
          Relationship to Claims:
          - Write-offs are linked to procedures via `procedure_id`
          - A claim procedure may have associated write-offs if the procedure has adjustments
          - Write-offs are not directly linked to claims, only to procedures
          
          Accounting Impact:
          - Used for financial reporting and revenue reconciliation
          - Critical for understanding revenue adjustments and contractual obligations
          - Should be used instead of `write_off_amount` for all write-off analysis
          
          Data Quality:
          - Will be $0.00 if no write-off adjustments exist for the procedure
          - Multiple write-offs for the same procedure are aggregated
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 20000
              config:
                severity: warn
                description: "Write-off amounts should be reasonable for dental procedures (allows for large write-offs on complex cases)"

      - name: patient_responsibility
        description: >
          Amount patient is responsible for after insurance payment
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Calculation: Billed amount minus paid amount minus write-off amount
          - Business Rules: Must be non-negative, represents patient's financial obligation
          
          Accounting Impact:
          - Used for patient billing and collection activities
          - Critical for accounts receivable management and patient communication
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Patient responsibility amounts should be reasonable for dental procedures"

      - name: check_amount
        description: >
          Amount of the insurance check received
          
          Financial Context:
          - Currency: USD with 2 decimal precision
          - Calculation: Actual check amount from insurance payment
          - Business Rules: Must match paid amount for the procedure
          
          Accounting Impact:
          - Used for payment reconciliation and bank deposit tracking
          - Critical for financial reporting and audit compliance
        tests:
          - not_null:
              config:
                severity: warn
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10000
              config:
                severity: warn
                description: "Check amounts should be reasonable for dental procedures"

      - name: check_date
        description: >
          Date when the insurance check was received
          
          Business Context:
          - Used for payment timing analysis and revenue cycle management
          - Critical for understanding payment delays and collection efficiency
          - Enables time-based financial reporting and analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: payment_type_id
        description: >
          Type of payment received from insurance (numeric payment type code)
          
          Valid Values (from stg_opendental__claimpayment and int_insurance_payment_allocated):
          
          Regular Payments:
          - 261: High volume type (avg $341) - Major carriers: Cigna, Aetna, MetLife, United Healthcare
          - 303: Regular payments (avg $278) - Major carriers: MetLife, Guardian, Ameritas, Anthem
          - 464: Rare type (avg $184) - Single record from Delta Dental of California
          - 465: Delta Dental payments (avg $359) - Used exclusively by Delta Dental plans
          - 466: Rare type (avg $200) - Only United Concordia, used briefly in early 2023
          - 467: Electronic payment
          - 469: United Concordia payments (avg $482) - Used exclusively by United Concordia
          
          Refund Types (negative amounts):
          - 645: Large refunds (avg -$268)
          - 646: Small refunds (avg -$1)
          - 647: Medium refunds (avg -$88)
          - 661: Insurance refunds (avg -$106, range -$196 to -$55)
          
          Note: Payment type IDs link to the definition table for practice-specific payment type definitions.
          Source: `stg_opendental__claimpayment.payment_type_id` (see `_stg_opendental__claimpayment.yml` for complete documentation)
          
          Business Rules:
          - Determines payment processing workflow and reconciliation method
          - Affects deposit timing and bank reconciliation processes
          - Links to definition table for practice-specific payment type definitions
        tests:
          - not_null:
              config:
                severity: warn
                description: "Payment type ID is optional for claims without payments"
          - accepted_values:
              values: [261, 303, 464, 465, 466, 467, 469, 645, 646, 647, 661]
              config:
                severity: warn
                description: "Payment type must match values from stg_opendental__claimpayment. See _stg_opendental__claimpayment.yml for complete list and descriptions."

      - name: is_partial
        description: >
          Flag indicating if this is a partial payment
          
          Business Context:
          - Used to identify claims requiring additional payment processing
          - Critical for collection activities and payment follow-up
          - Affects revenue recognition and accounts receivable management
        tests:
          - not_null:
              config:
                severity: warn

      - name: eob_attachment_count
        description: >
          Number of EOB (Explanation of Benefits) attachments
          
          Data Quality Considerations:
          - NULL values are expected for pre-authorization/draft claims (`claim_id = 0`)
          - These claims haven't been submitted yet, so they don't have EOBs
          - Pre-auth claims are legitimate business records representing planned procedures
          
          Business Context:
          - Used for audit compliance and documentation tracking
          - Critical for insurance payment verification and dispute resolution
          - Enables documentation completeness analysis
        tests:
          - not_null:
              config:
                severity: warn
                where: "claim_id != 0"
                description: "EOB attachment count should be present for submitted claims (excluding pre-auth/draft claims)"
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 10
              config:
                severity: warn
                where: "eob_attachment_count IS NOT NULL"
                description: "EOB attachment count should be reasonable for claim documentation"

      - name: eob_attachment_ids
        description: >
          Array of EOB attachment IDs for documentation tracking
          
          Business Context:
          - Used for audit compliance and documentation retrieval
          - Critical for insurance payment verification and dispute resolution
          - Enables documentation completeness analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: eob_attachment_file_names
        description: >
          Array of EOB attachment file names for documentation tracking
          
          Business Context:
          - Used for audit compliance and documentation retrieval
          - Critical for insurance payment verification and dispute resolution
          - Enables documentation completeness analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: payment_status_category
        description: >
          Calculated payment status category for business analysis
          
          Valid Values:
          - 'Paid': Payment has been received (paid_amount > 0)
          - 'Pre-auth': Pre-authorization claim (claim_id = 0) - claim sent to insurance before procedure is performed
          - 'Denied': Claim was denied by insurance (claim_status = 'Denied')
          - 'Rejected': Claim was rejected due to errors (claim_status = 'Rejected')
          - 'Pending': Claim is awaiting processing - includes:
            * Submitted claims (claim_status = 'Submitted')
            * Received claims not yet paid (claim_status = 'R')
            * Sent claims awaiting response (claim_status = 'S')
            * Waiting claims in transition (claim_status = 'W')
            * Hold claims waiting for primary insurance (claim_status = 'H')
            * Regular claims with NULL status (should be rare)
          - 'Unknown': Legitimate unknown status from source system (claim_status = 'U') - approximately 5 records
          
          Calculation Logic:
          - Priority 1: paid_amount > 0 → 'Paid'
          - Priority 2: claim_id = 0 → 'Pre-auth'
          - Priority 3: Specific claim_status values → 'Denied', 'Rejected', 'Pending', 'Unknown'
          - Priority 4: NULL claim_status → 'Pending' (for regular claims)
          - Fallback: Any unmapped status → 'Unknown'
          
          Business Rules:
          - Pre-auth claims (claim_id = 0) are always 'Pre-auth' regardless of other fields
          - Claims with paid_amount > 0 are always 'Paid' regardless of claim_status
          - Most claim_status values ('R', 'S', 'W', 'H', 'Submitted') map to 'Pending' as they represent claims awaiting payment
          - Only claim_status = 'U' legitimately maps to 'Unknown' (rare edge case from source system)
          - Used for payment analysis and collection activities
        tests:
          - not_null
          - accepted_values:
              values: ['Paid', 'Denied', 'Pending', 'Rejected', 'Unknown', 'Pre-auth']
              config:
                description: "Payment status category must be one of the defined business states (including Pre-auth for claim_id = 0)"
          - dbt_utils.expression_is_true:
              expression: "!= 'Unknown'"
              config:
                severity: warn
                description: "Unknown payment status category should be rare (only claim_status = 'U'). If count increases, investigate data quality issues."

      - name: billing_status_category
        description: >
          Calculated billing status category for business analysis
          
          Valid Values:
          - 'Billable': Procedure is billable to insurance - includes:
            * Procedures with billed_amount > 0
            * Pre-auth claims with $0 billed_amount (will be billed when performed)
            * Procedures with $0 billed_amount but no_bill_insurance = false (not explicitly non-billable)
            * Procedures with $0 billed_amount and no_bill_insurance IS NULL (treat as billable)
          - 'Non-Billable': Procedure is not billable to insurance (no_bill_insurance = true)
          - 'Unknown': Billing status cannot be determined (fallback for edge cases)
          
          Calculation Logic:
          - Priority 1: billed_amount > 0 → 'Billable'
          - Priority 2: no_bill_insurance = true → 'Non-Billable'
          - Priority 3: claim_id = 0 AND billed_amount = 0 → 'Billable' (pre-auth claims)
          - Priority 4: billed_amount = 0 AND no_bill_insurance = false → 'Billable'
          - Priority 5: billed_amount = 0 AND no_bill_insurance IS NULL → 'Billable'
          - Fallback: Any edge cases → 'Unknown'
          
          Business Rules:
          - Pre-auth claims (claim_id = 0) with $0 billed_amount are considered 'Billable' because they represent procedures that will be billed when performed
          - Procedures with $0 billed_amount but no_bill_insurance = false are treated as 'Billable' (not explicitly marked as non-billable)
          - Procedures with $0 billed_amount and NULL no_bill_insurance flag are treated as 'Billable' (assume billable unless explicitly marked)
          - Only procedures explicitly marked with no_bill_insurance = true are 'Non-Billable'
          - Used for billing analysis and revenue recognition
        tests:
          - not_null
          - accepted_values:
              values: ['Billable', 'Non-Billable', 'Unknown']
              config:
                description: "Billing status category must be one of the defined business states"
          - dbt_utils.expression_is_true:
              expression: "!= 'Unknown'"
              config:
                severity: warn
                description: "Unknown billing status category should be rare (edge cases only). If count increases, investigate data quality issues."

      - name: payment_days_from_claim
        description: >
          Calculated number of days between claim submission and payment receipt
          
          Business Context:
          - Used for revenue cycle management and payment timing analysis
          - Critical for understanding payment delays and collection efficiency
          - Enables performance monitoring and process optimization
        tests:
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 365
              config:
                severity: warn
                description: "Payment days should be reasonable for insurance processing"

      - name: payment_completion_status
        description: >
          Calculated payment completion status for business analysis
          
          Valid Values:
          - 'Write-off': Amount was written off
          - 'Patient Balance': Patient is responsible for remaining amount
          - 'Fully Paid': Payment is complete
          - 'Partial Payment': Payment is incomplete
          
          Business Rules:
          - Automatically calculated based on payment amounts and write-offs
          - Used for collection analysis and accounts receivable management
        tests:
          - not_null
          - accepted_values:
              values: ['Write-off', 'Patient Balance', 'Fully Paid', 'Partial Payment']
              config:
                description: "Payment completion status must be one of the defined business states"

      - name: eob_documentation_status
        description: >
          Calculated EOB documentation status for audit compliance
          
          Valid Values:
          - 'Documented': EOB attachments are present
          - 'Payment Without EOB': Payment received but no EOB documentation
          - 'No Documentation': No payment or EOB documentation
          
          Business Rules:
          - Automatically calculated based on payment and EOB attachment data
          - Used for audit compliance and documentation tracking
        tests:
          - not_null
          - accepted_values:
              values: ['Documented', 'Payment Without EOB', 'No Documentation']
              config:
                description: "EOB documentation status must be one of the defined business states"

      - name: _created_at
        description: >
          Original creation timestamp from OpenDental source system
          
          Source Transformation:
          - OpenDental source: "DateEntry" (CamelCase as stored)
          - Represents: When the record was originally created in OpenDental
          - Usage: Business timeline analysis and record lifecycle tracking
        tests:
          - not_null

      - name: _updated_at
        description: >
          Last update timestamp from OpenDental source system
          
          Source Transformation:
          - OpenDental source: COALESCE("DateTStamp", "DateEntry")
          - Logic: Uses DateTStamp if available, falls back to DateEntry
          - Purpose: Change tracking and incremental loading
        tests:
          - not_null

      - name: _loaded_at
        description: >
          ETL pipeline loading timestamp - when the record was loaded into the data warehouse
          
          Source: ETL pipeline metadata (added during loading process)
          Purpose: Data lineage tracking and pipeline monitoring
          Usage: ETL debugging and data freshness validation
        tests:
          - not_null

      - name: carrier_id
        description: >
          Foreign key to the insurance carrier
          
          Business Context:
          - Links to insurance carrier information
          - Used for carrier-specific analysis and reporting
          - Critical for insurance plan management and billing
        tests:
          - not_null:
              config:
                severity: warn

      - name: subscriber_id
        description: >
          Foreign key to the insurance subscriber
          
          Business Context:
          - Links to subscriber information for insurance verification
          - Used for subscriber-specific analysis and reporting
          - Critical for insurance eligibility and coverage validation
        tests:
          - not_null:
              config:
                severity: warn

      - name: snapshot_date
        description: >
          Date of the claim status snapshot
          
          Business Context:
          - Used for historical claim status tracking
          - Critical for audit compliance and status change analysis
          - Enables historical reporting and trend analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: tracking_date
        description: >
          Date of the claim tracking event
          
          Business Context:
          - Used for claim processing workflow tracking
          - Critical for understanding claim processing timeline
          - Enables workflow analysis and process optimization
        tests:
          - not_null:
              config:
                severity: warn

      - name: snapshot_status
        description: >
          Status from the claim snapshot
          
          Business Context:
          - Historical claim status for audit and compliance tracking
          - Used for status change analysis and workflow monitoring
          - Critical for understanding claim processing history
        tests:
          - not_null:
              config:
                severity: warn

      - name: tracking_status
        description: >
          Status from the claim tracking event
          
          Business Context:
          - Current tracking status for workflow monitoring
          - Used for claim processing analysis and optimization
          - Critical for understanding claim processing workflow
        tests:
          - not_null:
              config:
                severity: warn

      - name: procedure_code
        description: >
          Procedure code for the claim
          
          Business Context:
          - Links to procedure code information
          - Used for procedure-specific analysis and reporting
          - Critical for billing accuracy and procedure tracking
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: code_prefix
        description: >
          Prefix for the procedure code
          
          Business Context:
          - Used for procedure code categorization
          - Critical for procedure grouping and analysis
          - Enables procedure code hierarchy analysis
          
          Data Quality Notes:
          - NULL is expected for numeric procedure codes (non-D-prefixed codes)
          - NULL is also expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: procedure_description
        description: >
          Full description of the procedure
          
          Business Context:
          - Used for procedure identification and reporting
          - Critical for procedure analysis and documentation
          - Enables procedure-specific reporting and analysis
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: abbreviated_description
        description: >
          Abbreviated description of the procedure
          
          Business Context:
          - Used for procedure identification in reports
          - Critical for space-constrained reporting
          - Enables concise procedure reporting
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: procedure_time
        description: >
          Time required for the procedure
          
          Business Context:
          - Used for procedure scheduling and resource planning
          - Critical for operational efficiency analysis
          - Enables procedure time analysis and optimization
        tests:
          - not_null:
              config:
                severity: warn

      - name: procedure_category_id
        description: >
          Category ID for the procedure
          
          Business Context:
          - Links to procedure category information
          - Used for procedure categorization and analysis
          - Critical for procedure grouping and reporting
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: treatment_area
        description: >
          Area of treatment for the procedure
          
          Business Context:
          - Used for treatment area analysis and reporting
          - Critical for treatment planning and analysis
          - Enables treatment area-specific reporting
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: is_prosthetic
        description: >
          Flag indicating if the procedure is prosthetic
          
          Business Context:
          - Used for prosthetic procedure identification
          - Critical for prosthetic analysis and reporting
          - Enables prosthetic-specific analysis
          
          Data Quality Notes:
          - PostgreSQL boolean field (true/false)
          - NULL is legitimate when procedure definitions don't exist (e.g., pre-auth claims)
          - false (0 in source) is NOT NULL - NULL means "procedure definition not available"
        tests:
          - accepted_values:
              values: [true, false]
              config:
                where: "is_prosthetic IS NOT NULL"

      - name: is_hygiene
        description: >
          Flag indicating if the procedure is hygiene-related
          
          Business Context:
          - Used for hygiene procedure identification
          - Critical for hygiene analysis and reporting
          - Enables hygiene-specific analysis
          
          Data Quality Notes:
          - PostgreSQL boolean field (true/false)
          - NULL is legitimate when procedure definitions don't exist (e.g., pre-auth claims)
          - false (0 in source) is NOT NULL - NULL means "procedure definition not available"
        tests:
          - accepted_values:
              values: [true, false]
              config:
                where: "is_hygiene IS NOT NULL"

      - name: base_units
        description: >
          Base units for the procedure
          
          Business Context:
          - Used for procedure unit calculation
          - Critical for billing accuracy and procedure tracking
          - Enables unit-based analysis and reporting
          
          Data Quality Notes:
          - NULL is expected for pre-auth claims (claim_id = 0) where procedure definitions haven't been set up yet
        tests: []

      - name: is_radiology
        description: >
          Flag indicating if the procedure is radiology-related
          
          Business Context:
          - Used for radiology procedure identification
          - Critical for radiology analysis and reporting
          - Enables radiology-specific analysis
          
          Data Quality Notes:
          - PostgreSQL boolean field (true/false)
          - NULL is legitimate when procedure definitions don't exist (e.g., pre-auth claims)
          - false (0 in source) is NOT NULL - NULL means "procedure definition not available"
        tests:
          - accepted_values:
              values: [true, false]
              config:
                where: "is_radiology IS NOT NULL"

      - name: no_bill_insurance
        description: >
          Flag indicating if the procedure should not be billed to insurance
          
          Business Context:
          - Used for billing determination
          - Critical for billing accuracy and revenue recognition
          - Enables billing-specific analysis
          
          Data Quality Notes:
          - PostgreSQL boolean field (true/false)
          - NULL is legitimate when procedure definitions don't exist (e.g., pre-auth claims)
          - false (0 in source) is NOT NULL - NULL means "procedure definition not available"
        tests:
          - accepted_values:
              values: [true, false]
              config:
                where: "no_bill_insurance IS NOT NULL"

      - name: default_claim_note
        description: >
          Default note for the claim
          
          Business Context:
          - Used for claim documentation
          - Critical for claim processing and documentation
          - Enables claim note analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: medical_code
        description: >
          Medical code for the procedure
          
          Business Context:
          - Used for medical coding and billing
          - Critical for billing accuracy and compliance
          - Enables medical code analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: diagnostic_codes
        description: >
          Diagnostic codes for the procedure
          
          Business Context:
          - Used for diagnostic coding and billing
          - Critical for billing accuracy and compliance
          - Enables diagnostic code analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: plan_type
        description: >
          Type of insurance plan
          
          Business Context:
          - Used for plan type analysis and reporting
          - Critical for plan-specific analysis
          - Enables plan type-specific reporting
        tests:
          - not_null:
              config:
                severity: warn

      - name: group_number
        description: >
          Group number for the insurance plan
          
          Business Context:
          - Used for group identification and reporting
          - Critical for group-specific analysis
          - Enables group-specific reporting
        tests:
          - not_null:
              config:
                severity: warn

      - name: group_name
        description: >
          Group name for the insurance plan
          
          Business Context:
          - Used for group identification and reporting
          - Critical for group-specific analysis
          - Enables group-specific reporting
        tests:
          - not_null:
              config:
                severity: warn

      - name: verification_date
        description: >
          Date of insurance verification
          
          Business Context:
          - Used for verification timing analysis
          - Critical for verification process monitoring
          - Enables verification timeline analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: benefit_details
        description: >
          Details of insurance benefits
          
          Business Context:
          - Used for benefit analysis and reporting
          - Critical for benefit verification and analysis
          - Enables benefit-specific reporting
        tests:
          - not_null:
              config:
                severity: warn

      - name: verification_status
        description: >
          Status of insurance verification
          
          Business Context:
          - Used for verification status tracking
          - Critical for verification process monitoring
          - Enables verification status analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: effective_date
        description: >
          Effective date of the insurance plan
          
          Business Context:
          - Used for plan effective date analysis
          - Critical for plan coverage validation
          - Enables plan timeline analysis
        tests:
          - not_null:
              config:
                severity: warn

      - name: termination_date
        description: >
          Termination date of the insurance plan
          
          Business Context:
          - Used for plan termination analysis
          - Critical for plan coverage validation
          - Enables plan timeline analysis
        tests:
          - not_null:
              config:
                severity: warn

    tests:
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - claim_id
            - procedure_id
            - claim_procedure_id

    meta:
      owner: "Insurance Operations Team"
      contains_pii: true
      contains_phi: true
      business_process: "Insurance Billing and Revenue Cycle Management"
      refresh_frequency: "Daily"
      business_impact: "High"
      mart_type: "fact"
      grain_description: "One row per claim procedure (composite key: claim_id + procedure_id + claim_procedure_id)"
      primary_consumers: ["Insurance Operations Team", "Financial Analysis Team", "Revenue Cycle Team"]
      system_integration: "System A: Financial Management"
      data_quality_requirements:
        - "All fact records must have valid dimensional relationships"
        - "Financial amounts must be non-negative where applicable"
        - "Date fields must be valid and within business ranges"
        - "Status transitions must follow business rules"
        - "Composite keys must be unique"
        - "Payment amounts must be validated against business rules"
        - "EOB documentation must be tracked for audit compliance"
      performance_requirements:
        - "Model must support daily refresh within 30 minutes"
        - "Query performance must support real-time dashboard updates"
        - "Indexes must be optimized for common query patterns"
        - "Aggregations must be pre-calculated for reporting efficiency" 