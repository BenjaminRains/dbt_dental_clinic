version: 2

models:
  - name: int_claim_tracking
    description: >
      Complete tracking history for insurance claims, preserving all status updates and notes.
      Each record represents a tracking entry for a claim, showing its progression through the insurance process.
      
      Key features:
      - Tracks all status changes and updates for insurance claims
      - Preserves detailed tracking notes and timestamps
      - Links to int_claim_details for validation
      - Maintains chronological history of claim progression
      
      Data Sources:
      - stg_opendental__claimtracking: Base tracking information (PRIMARY SOURCE)
      - int_claim_details: Validation against claim details
      
      Metadata Strategy:
      - Primary source: claimtracking (stg_opendental__claimtracking) - contains core tracking details and business timestamps
      - Preserves business timestamps from primary source for audit trail (_created_at only, no _updated_at or _created_by available)
      - Maintains pipeline tracking with _loaded_at and _transformed_at for debugging
      - Uses standardize_intermediate_metadata macro for consistency
    
    config:
      materialized: table
      schema: int
      unique_key: [claim_tracking_id, claim_id, date_time_entry]
    
    columns:
      - name: claim_id
        description: Foreign key to the claim
        tests:
          - not_null
          - relationships:
              to: ref('int_claim_details')
              field: claim_id

      - name: claim_tracking_id
        description: Primary key for the tracking record
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__claimtracking')
              field: claim_tracking_id

      - name: tracking_type
        description: Type of tracking entry (e.g., sent, received, paid)
        tests:
          - not_null
          - accepted_values:
              values: ['ClaimProcReceived', 'StatusHistory', 'ClaimUser']

      - name: entry_timestamp
        description: Timestamp when the tracking entry was created
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2020-01-01'"
              max_value: "'2026-12-31'"

      - name: tracking_note
        description: Additional notes or comments about the tracking entry
        tests:
          - dbt_expectations.expect_column_values_to_not_be_null:
              where: "tracking_type in ('denied', 'pending')"
              severity: warn

      - name: _loaded_at
        description: >
          ETL extraction timestamp from primary source (claimtracking)
          
          Source: stg_opendental__claimtracking._loaded_at
          Purpose: Data lineage tracking and pipeline monitoring
          Usage: ETL debugging and data freshness validation
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2020-01-01 00:00:00'::timestamp"
              max_value: "current_timestamp"
              config:
                description: "Extraction timestamps must be within reasonable data processing window"
      
      - name: _created_at
        description: >
          Business creation timestamp from primary source (claimtracking)
          
          Source: stg_opendental__claimtracking._created_at
          Business Context: When the tracking entry was originally created in OpenDental
          Usage: Business timeline analysis and tracking lifecycle
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2020-01-01'"
              max_value: "'2026-12-31'"

      - name: _transformed_at
        description: >
          dbt intermediate model processing timestamp - when this model was last built
          
          Source: current_timestamp at dbt model execution
          Purpose: Intermediate model execution tracking and debugging
          Usage: Understanding data processing timeline and model refresh monitoring
        tests:
          - not_null:
              config:
                description: "Technical requirement for data lineage and model execution monitoring"

    tests:
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1000
          max_value: 100000

      - dbt_utils.expression_is_true:
          expression: "entry_timestamp <= current_timestamp"
          severity: warn
          name: warn_future_tracking_entries

      - dbt_utils.expression_is_true:
          expression: "not (tracking_type = 'denied' and tracking_note is null)"
          severity: warn
          name: warn_missing_denial_note

      - dbt_utils.expression_is_true:
          expression: "not (tracking_type = 'pending' and tracking_note is null)"
          severity: warn
          name: warn_missing_pending_note

      - dbt_expectations.expect_compound_columns_to_be_unique:
          column_list: [claim_tracking_id, claim_id, entry_timestamp]
          quote_columns: true
          ignore_row_if: "any_value_is_missing"
          severity: warn 