# =========== PATIENT INFORMATION ===========
version: 2

sources:
  - name: opendental
    description: "OpenDental backup database schema containing dental practice records"
    database: opendental_analytics
    schema: raw  # Raw data from ETL pipeline
    loader: postgres
    
    # Global settings for all tables
    loaded_at_field: "_loaded_at"
    freshness:
      warn_after: {count: 24, period: hour}
      error_after: {count: 720, period: hour}
    
    tables:
      - name: patient
        description: "Primary patient demographic and contact information"
        columns:
          - name: "PatNum"
            description: "Primary key for patient records"
            tests:
              - unique_quoted
              - not_null_quoted
          - name: "SecDateEntry"
            description: "Creation timestamp that can be null"
          - name: "DateTStamp"
            description: "Last update timestamp"
            tests:
              - not_null_quoted
              - expression_is_true_quoted:
                  expression: "\"DateTStamp\" <= current_timestamp"
        tests:
          - expression_is_true_quoted:
              expression: "\"PatNum\" > 0"
      
      - name: patientlink
        description: "Links between patient records, tracking relationships or merges between patients"
        columns:
          - name: "PatientLinkNum"
            description: "Primary key for patient link records"
            tests:
              - unique_quoted
              - not_null_quoted
          - name: "PatNumFrom"
            description: "Source patient identifier referencing the patient_id in patient table"
            tests:
              - not_null_quoted
          - name: "PatNumTo"
            description: "Destination patient identifier referencing the patient_id in patient table"
            tests:
              - not_null_quoted
          - name: "LinkType"
            description: "Type of relationship between patients"
            tests:
              - not_null_quoted
          - name: "DateTimeLink"
            description: "Timestamp when the link was created"
            tests:
              - not_null_quoted
              - expression_is_true_quoted:
                  expression: "\"DateTimeLink\" <= current_timestamp"
        tests:
          # - row_count:
          #     min_count: 50
          #     max_count: 200
          - expression_is_true_quoted:
              expression: "\"PatNumFrom\" != \"PatNumTo\""
      
      - name: patientnote
        description: "Clinical and administrative notes for patients"
        columns:
          - name: "PatNum"
            description: "Foreign key to patient, serves as primary key for patientnote"
            tests:
              - not_null_quoted
              - unique_quoted
          - name: "FamFinancial"
            description: "Family financial notes"
          - name: "ApptPhone"
            description: "Appointment phone notes"
          - name: "Medical"
            description: "Medical notes for the patient"
          - name: "Service"
            description: "Service notes"
          - name: "MedicalComp"
            description: "Medical compliance notes"
          - name: "Treatment"
            description: "Treatment notes"
          - name: "ICEName"
            description: "In Case of Emergency contact name"
          - name: "ICEPhone"
            description: "In Case of Emergency contact phone"
          - name: "OrthoMonthsTreatOverride"
            description: "Override for orthodontic treatment months"
          - name: "DateOrthoPlacementOverride"
            description: "Override date for orthodontic placement"
          - name: "SecDateTEntry"
            description: "Creation timestamp for the note"
            tests:
              - not_null_quoted
          - name: "SecDateTEdit"
            description: "Last update timestamp for the note"
            tests:
              - not_null_quoted
          - name: "Consent"
            description: "Consent indicator"
          - name: "UserNumOrthoLocked"
            description: "User number for orthodontic lock"
          - name: "Pronoun"
            description: "Patient's preferred pronoun"
        tests:
          - expression_is_true_quoted:
              expression: "\"SecDateTEdit\" >= \"SecDateTEntry\""
      
      - name: zipcode
        description: "Zip code reference information"
        columns:
          - name: "ZipCodeNum"
            description: "Primary key for zipcode records"
            tests:
              - unique_quoted
              - not_null_quoted
          - name: "ZipCodeDigits"
            description: "Postal code digits"
            tests:
              - not_null_quoted
          - name: "City"
            description: "City name associated with the zipcode"
          - name: "State"
            description: "State or province associated with the zipcode"
          - name: "IsFrequent"
            description: "Flag indicating if this zipcode is frequently used (0=no, 1=yes)"
        tests:
          - expression_is_true_quoted:
              expression: "\"IsFrequent\" IN (false, true)"
      
      - name: toothinitial
        description: "Initial conditions of patient teeth"
        freshness:
          warn_after: {count: 24, period: day}
          error_after: {count: 48, period: day}
        columns:
          - name: "ToothInitialNum"
            description: "Primary key for tooth initial conditions"
            tests:
              - unique_quoted
              - not_null_quoted
          - name: "PatNum"
            description: "Foreign key to patient"
            tests:
              - not_null_quoted
          - name: "ToothNum"
            description: "Tooth number identifier"
          - name: "InitialType"
            description: "Type code for initial tooth condition"
          - name: "Movement"
            description: "Movement measurement value"
          - name: "DrawingSegment"
            description: "Drawing segment data for tooth visualization"
          - name: "ColorDraw"
            description: "Color code for drawing visualization"
          - name: "SecDateTEntry"
            description: "Timestamp when the record was created"
            tests:
              - not_null_quoted
          - name: "SecDateTEdit"
            description: "Timestamp when the record was last updated"
            tests:
              - not_null_quoted
              - expression_is_true_quoted:
                  expression: "\"SecDateTEdit\" >= \"SecDateTEntry\""
          - name: "DrawText"
            description: "Text description for drawings"
