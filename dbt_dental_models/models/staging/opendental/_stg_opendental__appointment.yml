version: 2

models:
  - name: stg_opendental__appointment
    description: >
      Staging model for appointments from the OpenDental system. Contains normalized and cleaned 
      appointment data with standardized naming conventions for dental practice scheduling and workflow management.
      
      Business Context:
      - Central to dental practice operations supporting scheduling, capacity planning, and patient flow management
      - Includes both completed appointments (historical data) and scheduled appointments (future planning)
      - Tracks complete patient journey from scheduling through arrival, seating, and dismissal
      - Links appointments to procedures, providers, operatories, and insurance plans for comprehensive practice management
      - Supports hygiene workflows, new patient processing, and appointment type categorization
      - Critical for practice analytics, provider productivity, and patient care coordination
      
      Data Scope:
      - Contains all appointments from 2023-01-01 onwards with incremental updates
      - Includes future-dated appointments for treatment planning and capacity management
      - Covers all appointment statuses: scheduled, completed, broken/missed, and unscheduled
      - Links to patients, providers, operatories, appointment types, and insurance plans
      - Historical changes tracked separately in histappointment table
    
    meta:
      record_count: "~20,400 appointment records"
      data_scope: "All appointments from 2023-01-01 onwards with incremental updates"
      
      known_issues:
        - description: "409 past appointments still marked as Scheduled (Status 1) instead of Completed (Status 2)"
          severity: "warn"
          identified_date: "2025-01-01"
          jira_ticket: "DQ-123"
          test: "appt_past_scheduled"
        - description: "Broken/missed appointments missing procedure descriptions - Test updated to exclude consultation appointments (appointments without linked procedures). See validation/staging/appointment/BROKEN_APPOINTMENTS_FINDINGS.md for investigation details."
          severity: "warn"
          identified_date: "2025-01-01"
          updated_date: "2026-01-23"
          test: "appt_broken_wo_procs"
          resolution: "Test logic updated to only flag broken appointments that have linked procedures but missing descriptions. Consultation-type appointments (no procedures) are now excluded as they legitimately don't require procedure descriptions."
      
      business_rules:
        - rule: "Completed appointments (status = 2) must be in the past with dismissed_datetime populated"
          impact: "Essential for accurate practice productivity and billing analysis"
        - rule: "Scheduled appointments (status = 1) can be future-dated to support treatment planning"
          impact: "Enables capacity planning and patient scheduling workflows"
        - rule: "Broken/Missed appointments (status = 5) should have procedure descriptions for workflow analysis"
          impact: "Critical for understanding appointment failure patterns and practice efficiency"
        - rule: "Patient flow timestamps (arrival, seated, dismissed) must follow chronological order"
          impact: "Ensures accurate patient flow analysis and operatory efficiency metrics"
      
      usage_notes: >
        - Future appointments are essential for scheduling and capacity planning - do not filter out
        - Use appointment_status to filter by workflow state: 1=Scheduled, 2=Completed, 5=Broken/Missed
        - Patient flow analysis requires arrival_datetime, seated_datetime, and dismissed_datetime
        - Join with procedurelog for detailed procedure information and billing analysis
        - is_hygiene flag distinguishes hygiene appointments from general dental procedures
        - operatory_id and provider_id enable resource utilization and capacity analysis

    tests:
      - dbt_utils.expression_is_true:
          name: valid_appointment_status
          expression: "appointment_status in (1,2,3,5,6)"
          severity: error
      - dbt_utils.expression_is_true:
          name: completed_appointments_in_past
          expression: "appointment_status != 2 OR appointment_datetime <= current_date"
          severity: error
      - dbt_utils.expression_is_true:
          name: scheduled_appointments_have_datetime
          expression: "appointment_status != 1 OR appointment_datetime IS NOT NULL"
          severity: error

    columns:
      # Primary Key
      - name: appointment_id
        description: "Primary key - Unique identifier for each appointment (maps to AptNum in OpenDental)"
        tests:
          - unique
          - not_null
          - positive_values

      # Core Foreign Keys
      - name: patient_id
        description: "Foreign key to patient who has the appointment. Links to patient demographics and clinical history."
        tests:
          - not_null
          - relationships:
              to: ref('stg_opendental__patient')
              field: patient_id
              severity: error

      - name: provider_id
        description: "Foreign key to the primary provider for this appointment. May be NULL for hygiene-only appointments."
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id
              severity: warn
              where: "provider_id IS NOT NULL"

      - name: hygienist_id
        description: "Foreign key to the hygienist assigned to this appointment. Used for hygiene appointments and provider coordination."
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id
              severity: warn
              where: "hygienist_id IS NOT NULL"

      # Operational Foreign Keys
      - name: assistant_id
        description: "Foreign key to the dental assistant assigned to this appointment for procedure support."

      - name: clinic_id
        description: "Foreign key to the clinic where the appointment is scheduled. Supports multi-location practices."

      - name: operatory_id
        description: "Foreign key to the operatory/treatment room where the appointment is scheduled. Critical for capacity planning."

      - name: appointment_type_id
        description: >
          Foreign key to appointment type classification (e.g., cleaning, emergency, consultation).
          0 = 'None' (valid default for appointments without specific type designation).
          
          Data Quality Notes:
          - Appointments with appointment_type_id = 0 are more likely to have data quality issues.
          - 68.7% of broken appointments without procedures (pre-test-update cohort) had type_id = 0.
          - 87.5% of past appointments still marked as scheduled had type_id = 0.
          - Consider reviewing workflow for appointments created without a specific type; monitor rate via
            validation/staging/appointment/monitor_unclassified_appointment_rate.sql.
          - See validation/staging/appointment/APPOINTMENT_TYPE_CLASSIFICATION_INVESTIGATION.md for details.
        tests:
          - relationships:
              to: ref('stg_opendental__appointmenttype')
              field: appointment_type_id
              severity: warn

      # Scheduling and Workflow Foreign Keys
      - name: next_appointment_id
        description: "Foreign key to the next appointment in a treatment series. Supports multi-visit treatment planning."

      - name: insurance_plan_1_id
        description: "Foreign key to the primary insurance plan for this appointment. Used for benefits verification and billing."

      - name: insurance_plan_2_id
        description: "Foreign key to the secondary insurance plan for this appointment. Supports dual coverage scenarios."

      - name: unscheduled_status_id
        description: "Status identifier for unscheduled appointments. Used in appointment request and scheduling workflows."

      - name: entered_by_user_id
        description: "Foreign key to the user who created this appointment record. Tracks scheduling responsibility."

      # Critical Datetime Fields
      - name: appointment_datetime
        description: >
          Date and time of the scheduled appointment. Future dates are valid and essential for treatment planning.
          Used for scheduling, capacity planning, and patient communication.
        tests:
          - not_null

      # Patient Flow Timestamps
      - name: arrival_datetime
        description: >
          Date and time when the patient arrived for their appointment.
          NULL for future appointments or when patient arrival is not tracked.

      - name: seated_datetime
        description: >
          Date and time when the patient was seated in the operatory.
          Critical for operatory efficiency analysis and patient flow metrics.

      - name: dismissed_datetime
        description: >
          Date and time when the patient was dismissed after completing their appointment.
          Required for completed appointments (status = 2) and used for duration analysis.

      - name: asked_to_arrive_datetime
        description: >
          Date and time when the patient was asked to arrive (may be earlier than appointment_datetime).
          Used for patient communication and check-in workflow management.

      # Status and Classification
      - name: appointment_status
        description: >
          Status code for the appointment workflow:
          1 = Scheduled (includes future appointments for treatment planning)
          2 = Completed (appointment finished, must be in past)
          3 = Unknown/UnschedList (requires investigation and status correction)
          4 = ASAP (urgent appointment requiring immediate attention) - Note: May appear in intermediate models
          5 = Broken/Missed (patient did not attend scheduled appointment)
          6 = Unscheduled/Planned (appointment removed from schedule or planned but not scheduled)
          7 = PtNote (patient note appointment) - Note: May appear in intermediate models
          8 = PtNoteCompleted (patient note appointment completed) - Note: May appear in intermediate models
          
          Data Quality Notes:
          - Staging model contains values [1, 2, 3, 5, 6] as documented
          - Intermediate models may include additional values [4, 7, 8] from source system variations
          - Status 3 (Unknown) should be investigated and corrected in source system
          - Status 4 (ASAP) is valid but may not appear in all staging extracts
          - Status 7 and 8 (PtNote variants) are valid but may not appear in all staging extracts
          
          Mapping Considerations:
          - Downstream mart models should handle all possible values [1, 2, 3, 4, 5, 6, 7, 8]
          - Status 2 and 8 both represent completed appointments
          - Status 1 and 6 both represent scheduled/planned appointments
          - Status 3 should map to 'Unscheduled' or 'Unknown' depending on business rules
          - See fact_appointment model for complete mapping logic
        tests:
          - not_null
          - accepted_values:
              values: [1, 2, 3, 5, 6]
              config:
                description: "Appointment status must be one of the documented workflow states. Note: Values 4, 7, 8 may appear in intermediate models."

      - name: confirmation_status
        description: >
          Status code for appointment confirmation (e.g., unconfirmed, confirmed, left message).
          Used for patient communication workflows and appointment risk assessment.

      - name: priority
        description: "Priority level for the appointment (emergency, urgent, routine). Affects scheduling and resource allocation."

      # Appointment Characteristics
      - name: is_new_patient
        description: "Boolean flag indicating if this is a new patient appointment (0=Existing, 1=New converted to boolean)"
        tests:
          - accepted_values:
              values: [true, false]
              quote: false

      - name: is_hygiene
        description: "Boolean flag indicating if this is a hygiene appointment (0=General, 1=Hygiene converted to boolean)"
        tests:
          - accepted_values:
              values: [true, false]
              quote: false

      - name: is_time_locked
        description: "Boolean flag indicating if the appointment time is locked and cannot be changed (0=Unlocked, 1=Locked converted to boolean)"
        tests:
          - accepted_values:
              values: [true, false]
              quote: false

      # Scheduling and Display
      - name: pattern
        description: >
          Pattern string representing time units for the appointment schedule display.
          Uses visual blocks (e.g., "XXX") to represent appointment duration in the scheduler.

      - name: pattern_secondary
        description: "Secondary pattern string for additional time allocation or overlapping appointments."

      - name: color_override
        description: "Custom color code to override default display color for this appointment in the scheduler."

      - name: item_order_planned
        description: "Numeric value for ordering planned appointments in treatment planning workflows."

      # Clinical and Administrative Notes
      - name: note
        description: "Free text notes related to the appointment including special instructions and patient requests."

      - name: procedure_description
        description: >
          Text description of procedures associated with this appointment.
          
          Data Quality Notes:
          - May be NULL for hygiene appointments (is_hygiene = true) as procedures are often not pre-specified
          - May be NULL for consultation-type appointments that don't have linked procedures in procedurelog
          - Consultation appointments (e.g., implant consults, AOX consults, new patient intakes) may legitimately have NULL procedure_description
          - Broken appointments without linked procedures are expected to have NULL procedure_description (see BROKEN_APPOINTMENTS_FINDINGS.md)
          
          Business Rules:
          - Procedure descriptions are required for broken/missed non-hygiene appointments that have linked procedures
          - Consultation appointments that are broken before procedures are created may have NULL procedure_description

      - name: procedures_colored
        description: "Text describing procedures with color coding information for scheduler display."

      - name: provider_bar_text
        description: "Text to display in the provider bar section of the scheduler for quick reference."

      # Security and System
      - name: security_hash
        description: "Hash value for security and audit purposes. Used for data integrity verification."

      # Required Metadata Columns
      - name: _loaded_at
        description: "Timestamp when the data was loaded into the data warehouse by the ETL pipeline"
        tests:
          - not_null

      - name: _transformed_at
        description: "Timestamp when this dbt model was last built/transformed"
        tests:
          - not_null

      - name: _created_at
        description: |
         "Timestamp when the record was created in the source system (OpenDental). Maps to SecDateTEntry column."
         Note: 4 appointments have NULL _created_at (system-generated with _created_by=0)
        tests:
          - not_null:
              config:
                severity: warn

      - name: _updated_at
        description: "Timestamp when the record was last updated in the source system (OpenDental). Maps to DateTStamp column."
        tests:
          - not_null

      - name: _created_by
        description: "User who created the record in the source system (OpenDental). Maps to SecUserNumEntry column."
        tests:
          - not_null