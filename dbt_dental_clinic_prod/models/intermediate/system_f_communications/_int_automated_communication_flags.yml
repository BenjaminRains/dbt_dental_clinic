version: 2

models:
  - name: int_automated_communication_flags
    description: >
      Intermediate model for automated communication flags that identifies and categorizes
      automated communications from the base communications model. This model serves as
      the foundation for analyzing automated communication effectiveness and patterns.
      
      Grain: One row per automated communication event. Each record represents a single
      automated communication (email, text, etc.) that has been flagged as automated
      based on content patterns, program IDs, or batch characteristics.
      
      Key Features:
      - Pattern-based automation detection using content analysis
      - Batch communication identification for system-generated messages
      - Trigger type categorization (appointment, billing, clinical, etc.)
      - Campaign type identification for marketing communications
      - Engagement tracking (opens, clicks, replies, bounces)
      - Status determination based on communication outcomes
      - Comprehensive metadata preservation for data lineage
      
      Business Logic Features:
      - Automation Detection: Uses content patterns, program IDs, and batch analysis
      - Trigger Categorization: Identifies communication purpose (appointment, billing, etc.)
      - Campaign Tracking: Links communications to specific marketing campaigns
      - Engagement Metrics: Tracks opens, clicks, replies, and bounces
      - Status Classification: Determines communication success/failure status
      
      Data Sources:
      - int_patient_communications_base: Primary source of communication data
      - stg_opendental__commlog: Secondary source for reply tracking
      
      Data Quality Notes:
      - Filters to outbound communications only (automated comms are primarily outbound)
      - Handles future dates for scheduled automated communications
      - Validates batch detection to prevent false positives
      - Limits processing scope for performance optimization
      - Preserves metadata from primary source for data lineage tracking
      
      Performance Notes:
      - Pre-aggregates batch communications to avoid repeated subqueries
      - Pre-aggregates replies to avoid repeated subqueries
      - Uses CTEs to improve query readability and performance
      - Optimizes pattern matching with pre-filtered content
      - Adds indexes for frequently joined columns
      - Implements row limits for debugging and performance control
      
    config:
      materialized: incremental
      schema: intermediate
      unique_key: communication_id
      on_schema_change: fail
      incremental_strategy: merge
    
    columns:
      - name: communication_id
        description: >
          Primary key - Unique identifier for the communication record.
          Direct mapping from communication_id in the base model.
          
          Business Rules:
          - Must be unique across all automated communications
          - Links back to the base communications model
          - Used for deduplication and incremental processing
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('int_patient_communications_base')
              field: communication_id
      
      - name: patient_id
        description: >
          Foreign key to the patient profile. Identifies which patient
          this automated communication is associated with.
          
          Business Rules:
          - Must reference a valid patient in the system
          - Used for patient-specific communication analysis
          - Critical for HIPAA compliance and audit trails
          
          Data Quality Notes:
          - Some patient IDs may not exist in int_patient_profile due to data timing
          - This is expected for automated communications to patients not yet in profile
        tests:
          - not_null
          - relationships:
              to: ref('int_patient_profile')
              field: patient_id
              severity: warn
              config:
                description: "Patient should exist in profile, but some may be missing due to data timing"
      
      - name: automated_communication_id
        description: >
          Surrogate key for automated communication tracking. Generated from
          communication_id and content to ensure uniqueness for automated
          communication analysis.
          
          Business Rules:
          - Generated using dbt_utils.generate_surrogate_key
          - Combines communication_id and content for uniqueness
          - Used for automated communication-specific analytics
        tests:
          - unique
          - not_null
      
      - name: direction
        description: >
          Communication direction - indicates whether the communication was
          outbound (sent from office) or inbound (received by office).
          
          Business Rules:
          - Automated communications are primarily outbound
          - Used for filtering and analysis of communication patterns
          - Critical for understanding communication flow
        tests:
          - not_null
          - accepted_values:
              values: ['outbound', 'inbound', 'system', 'unknown']
      
      - name: is_automated
        description: >
          Flag indicating whether this communication was automated.
          
          Logic:
          - true when: Content matches automation patterns, has program_id, or is part of batch
          - false when: Manual communication with no automation indicators
          
          Business Impact:
          - Used to filter automated vs manual communications
          - Critical for automation effectiveness analysis
          - Supports ROI calculations for automated systems
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
      
      - name: trigger_type
        description: >
          Categorized trigger type that caused this automated communication.
          
          Business Rules:
          - appointment_reminder: Automated appointment reminders and confirmations
          - appointment_confirmation: Confirmed appointment notifications
          - broken_appointment: Cancelled or broken appointment notifications
          - balance_notice: Financial balance and payment notifications
          - patient_response: Patient interaction responses
          - preference_update: Opt-in/opt-out preference changes
          - review_request: Patient review and feedback requests
          - form_request: Form completion and update requests
          - post_op_instructions: Post-operative care instructions
          - annual_notification: Annual and year-end communications
          - delivery_failure: Failed delivery notifications
          - other: Uncategorized automated communications
        tests:
          - not_null
          - accepted_values:
              values: [
                'appointment_reminder', 'appointment_confirmation', 'broken_appointment',
                'balance_notice', 'patient_response', 'preference_update', 'review_request',
                'form_request', 'post_op_instructions', 'annual_notification',
                'delivery_failure', 'other'
              ]
      
      - name: campaign_type
        description: >
          Specific campaign type for marketing communications.
          
          Business Rules:
          - appointment_reminders: Automated appointment reminder campaigns
          - accounts_receivable: Financial balance and payment campaigns
          - crown_instructions: Post-operative crown care campaigns
          - form_invite: Form completion invitation campaigns
          - unscheduled_treatment: Treatment scheduling campaigns
          - NULL: Non-campaign communications
        tests:
          - accepted_values:
              values: [
                'appointment_reminders', 'accounts_receivable', 'crown_instructions',
                'form_invite', 'unscheduled_treatment'
              ]
              where: "campaign_type is not null"
      
      - name: status
        description: >
          Communication status based on outcome and engagement.
          
          Business Rules:
          - responded_positive: Patient confirmed or rescheduled
          - responded_negative: Patient cancelled or declined
          - undelivered: Communication failed to deliver
          - sent: Communication sent successfully (default)
        tests:
          - not_null
          - accepted_values:
              values: ['responded_positive', 'responded_negative', 'undelivered', 'sent']
      
      - name: open_count
        description: >
          Number of times the communication was opened (email only).
          
          Business Rules:
          - Only applicable for email communications (communication_mode = 1)
          - Extracted from content patterns indicating opens
          - Used for email engagement analysis
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              config:
                severity: warn
                description: "Open count should be 0 or 1 per communication"
      
      - name: click_count
        description: >
          Number of times links in the communication were clicked (email only).
          
          Business Rules:
          - Only applicable for email communications (communication_mode = 1)
          - Extracted from content patterns indicating clicks
          - Used for email engagement and conversion analysis
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              config:
                severity: warn
                description: "Click count should be 0 or 1 per communication"
      
      - name: reply_count
        description: >
          Number of replies received to this communication.
          
          Business Rules:
          - Tracks inbound responses within 3 days of communication
          - Used for engagement and response rate analysis
          - Critical for measuring communication effectiveness
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              config:
                severity: warn
                description: "Reply count should be 0 or 1 per communication"
      
      - name: bounce_count
        description: >
          Number of delivery failures for this communication (email only).
          
          Business Rules:
          - Only applicable for email communications (communication_mode = 1)
          - Extracted from content patterns indicating bounces
          - Used for email deliverability analysis
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: 0
              max_value: 1
              config:
                severity: warn
                description: "Bounce count should be 0 or 1 per communication"
      
      - name: communication_datetime
        description: >
          Timestamp when the automated communication was sent.
          
          Business Rules:
          - Represents when the automated system sent the communication
          - Can include future dates for scheduled communications
          - Used for temporal analysis and scheduling optimization
        tests:
          - not_null
          - dbt_expectations.expect_column_values_to_be_between:
              min_value: "'2020-01-01'"
              max_value: "'2030-12-31'"
              config:
                severity: warn
                description: "Communication datetime should be within reasonable range"
      
      - name: communication_mode
        description: >
          Mode of communication (email, text, phone, etc.).
          
          Business Rules:
          - manual_note: Email communications (mode = 1)
          - text_message: Text message communications (mode = 4, 5)
          - phone_call: Phone communications (mode = 3)
          - system_note: System-generated notes (mode = 0)
          - other: Various other communication types (mode = 2, 6, 8)
          - unknown: Unrecognized mode values
        tests:
          - not_null
          - accepted_values:
              values: ['system_note', 'manual_note', 'other', 'phone_call', 'text_message', 'unknown']
      
      # Metadata Fields
      - name: _loaded_at
        description: >
          ETL extraction timestamp from primary source (communication base)
          Source: int_patient_communications_base._loaded_at
          Purpose: Data lineage tracking and pipeline monitoring
          Note: Preserved from primary source for complete audit trail
        tests:
          - not_null
      
      - name: _created_at
        description: >
          Business creation timestamp from primary source (communication base)
          Source: int_patient_communications_base._created_at
          Purpose: Business timeline analysis and audit trail
          Note: Maps to DateTStamp in OpenDental source system
        tests:
          - not_null
      
      - name: _transformed_at
        description: >
          dbt intermediate model build timestamp - when this model was built
          Source: dbt model execution
          Purpose: Model-specific tracking and pipeline debugging
          Note: Generated by standardize_intermediate_metadata macro
        tests:
          - not_null
    
    tests:
      # Business Rule Tests
      - dbt_expectations.expect_table_row_count_to_be_between:
          min_value: 1
          max_value: 1000000
          config:
            severity: error
            description: "Automated communications should exist but not exceed reasonable limits"
      
      - dbt_expectations.expression_is_true:
          expression: "is_automated = true"
          config:
            severity: error
            description: "All records in this model should be flagged as automated"
      
      - dbt_expectations.expression_is_true:
          expression: "direction = 'outbound'"
          config:
            severity: error
            description: "Automated communications should be outbound"
      
      # Data Quality Tests
      - dbt_expectations.expression_is_true:
          expression: "communication_datetime >= '2020-01-01'"
          config:
            severity: warn
            description: "Communications should be from 2020 onwards"
      
      - dbt_expectations.expression_is_true:
          expression: "open_count + click_count + reply_count + bounce_count <= 4"
          config:
            severity: warn
            description: "Total engagement metrics should not exceed 4 per communication"
      
      # Referential Integrity Tests
      - dbt_utils.expression_is_true:
          expression: "patient_id is not null and patient_id > 0"
          config:
            severity: error
            description: "All communications must have valid patient IDs"
    
    meta:
      owner: "dental_communications_team"
      contains_pii: true
      business_process: "Automated Communications Management"
      refresh_frequency: "daily"
      business_impact: "High"
      system_integration: "System F: Communications"
      data_quality_requirements:
        - "All automated communications must be properly flagged"
        - "Trigger types must be accurately categorized"
        - "Engagement metrics must be validated"
        - "Metadata must be preserved for audit trails"
      performance_requirements:
        - "Model must process within 5 minutes"
        - "Incremental processing must handle daily updates efficiently"
        - "Batch detection must be optimized for performance" 