version: 2

models:
  - name: int_appointment_metrics
    description: >
      Comprehensive metrics model that aggregates appointment data to provide key performance
      indicators and operational insights for the dental clinic. This model serves as the
      foundation for scheduling analytics and performance reporting.
      
      Key Features:
      - Multi-level aggregation (provider-level and overall clinic metrics)
      - Rolling 7-day averages for trend analysis and performance tracking
      - Month-to-date cumulative metrics for period-based reporting
      - Schedule utilization calculations with complete date spine coverage
      - Chair time utilization vs scheduled time analysis for efficiency monitoring
      - Rate calculations with proper null handling and business rule validation
      
      Data Sources:
      - int_appointment_details: Base appointment data with status, timing, and completion information
      - int_appointment_schedule: Schedule patterns, blocks, and utilization data
      - stg_opendental__provider: Provider information including active status and specialties
      
      Business Logic Features:
      - Provider-level and overall clinic metric aggregation using UNION ALL patterns
      - Rolling window calculations for trend analysis (7-day rolling averages)
      - Month-to-date cumulative calculations for period-based reporting
      - Schedule utilization with date spine to ensure complete coverage
      - Chair time efficiency calculations comparing actual vs scheduled time
      - Rate calculations with division-by-zero protection and business rule validation
      
      Data Quality Notes:
      - Uses date spine to ensure complete date coverage for all providers without gaps
      - Handles null values in utilization calculations with proper default values (480 minutes)
      - Excludes hidden providers from overall metrics to maintain data quality
      - Limits processing to 90-day rolling window for optimal performance
      - Validates metric calculations with business rule constraints and rate boundaries
      
      Performance Notes:
      - Incremental materialization based on date for efficient daily processing
      - Pre-aggregated CTEs to avoid repeated subqueries and improve performance
      - Indexed on key lookup fields (metric_id, provider_id, date) for downstream model performance
      - Date spine optimization ensures complete coverage without performance gaps
      - Organized CTE structure following complex model patterns for maintainability
      
    config:
      materialized: incremental
      schema: intermediate
      unique_key: metric_id
      
    meta:
      owner: "Scheduling Team"
      contains_pii: false
      business_process: "Appointment Performance Analytics"
      refresh_frequency: "Daily"
      business_impact: "High"
      system_integration: "System G: Scheduling"
      data_quality_requirements:
        - "Metrics must be accurate for provider performance evaluation"
        - "Rate calculations must handle edge cases and null values properly"
        - "Date coverage must be complete for trend analysis and reporting"
      performance_requirements:
        - "Model must process incremental updates efficiently for daily operations"
        - "Rolling calculations must complete within acceptable time limits"

    columns:
      - name: metric_id
        description: >
          Primary key - Unique identifier for the metrics record
          
          Business Rules:
          - Must be unique across all metric records
          - Generated using MD5 hash of provider_id, date, and metric_level
          - Cannot be null or empty
        tests:
          - unique
          - not_null
      - name: date
        description: Date of the metrics
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= (CURRENT_DATE - INTERVAL '90 days')"
      - name: provider_id
        description: ID of the provider (for provider-level metrics)
        tests:
          - relationships:
              to: ref('stg_opendental__provider')
              field: provider_id
              config:
                severity: warn
      - name: metric_level
        description: >
          Level of aggregation for the metrics
          
          Logic:
          - 'provider': Metrics aggregated at individual provider level
          - 'overall': Metrics aggregated across all providers for clinic-wide view
          
          Business Impact:
          - Enables provider-specific performance analysis and comparison
          - Supports clinic-wide operational reporting and trend analysis
          - Critical for both individual provider evaluation and overall clinic efficiency monitoring
        tests:
          - not_null
          - accepted_values:
              values: ['provider', 'overall']
      - name: total_appointments
        description: Total number of appointments scheduled for the day
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: completed_appointments
        description: Number of appointments marked as complete
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= total_appointments"
      - name: cancelled_appointments
        description: Number of appointments that were cancelled
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= total_appointments"
      - name: no_show_rate
        description: Percentage of appointments where patient did not show up
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= 100"
      - name: cancellation_rate
        description: Percentage of appointments that were cancelled
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= 100"
      - name: completion_rate
        description: >
          Percentage of appointments that were completed
          
          Calculation Logic:
          - completion_rate = (completed_appointments / total_appointments) * 100
          - Returns 0 when total_appointments = 0 to avoid division by zero
          - Calculated for both provider-level and overall metrics
          
          Business Rules:
          - Must be between 0 and 100
          - Cannot exceed 100% completion rate
          - Used for provider performance evaluation and clinic efficiency monitoring
          
          Data Quality Notes:
          - Handles division by zero with proper default value of 0
          - Calculated consistently across all metric levels
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= 100"
      - name: schedule_utilization
        description: Percentage of available scheduling time that was booked
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "IS NULL OR total_appointments > 0"
      - name: chair_time_utilization
        description: Percentage of scheduled chair time that was actually used
        tests:
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= 100"
          - dbt_utils.expression_is_true:
              expression: "IS NULL OR completed_appointments > 0"
      - name: average_appointment_length
        description: Average duration of appointments in minutes
        tests:
          - dbt_utils.expression_is_true:
              expression: "> 0"
          - dbt_utils.expression_is_true:
              expression: "IS NULL OR completed_appointments > 0"
      - name: average_wait_time
        description: Average time patients waited before being seen (minutes)
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
      - name: new_patient_rate
        description: Percentage of appointments that were for new patients
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: ">= 0"
          - dbt_utils.expression_is_true:
              expression: "<= 100"
      - name: dbt_created_at
        description: Timestamp when this record was created in the dbt model
        tests:
          - not_null
      - name: dbt_pipeline_id
        description: Unique identifier for the dbt pipeline run that created this record
        tests:
          - not_null
      - name: dbt_model
        description: Name of the dbt model that created this record
        tests:
          - not_null
      - name: dbt_schema
        description: Schema where this model is materialized
        tests:
          - not_null
